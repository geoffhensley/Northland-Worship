<!doctype html>
<html lang="en">
<head>
    {!-- Required meta tags --}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">

    <title>Online Worship - Northland Church</title>
    <meta content="Northland Church" property="og:title">
    <meta content="video.other" property="og:type">
    <meta content="https://uploads-ssl.webflow.com/5a941dc804115100018caf6f/5d516efba4a37052c58dbb99_MondayHomepage-FullyAlive-2200x1200.jpg" property="og:image">
    <meta content="Engaging people to be fully alive in Jesus. We believe the church is more than a place you come to on Sundays ... it's people. People fully alive in Jesus — not just lung-breathing, heart-beating life, but abundant, thriving Life that can only come from Him." name="description" property="og:description">
    <meta content="https://northlandchurch.church/worship/" property="og:url">

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script type="text/javascript">WebFont.load({ google: {families: ["Roboto Condensed:300,regular,700","Roboto Mono:regular"]}});</script>

    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    {!-- Relative stylesheet inside EE template group --}
	<link rel="stylesheet" href="style">

    {!-- Global site tag (gtag.js) - Google Analytics --}
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-966214-29"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-966214-29');
    </script>
</head>

<body>
<?php
	// Establish chat id, use member ID if logged in, otherwise generate new one
	$member_id_reference = $this->EE->session->userdata('member_id');
	if ($member_id_reference == 0) 
	{
		$member_id_reference = 1;

		$sql="UPDATE usercounter SET counter = counter + 1";
		mysql_query($sql) or die();
		$sql = "SELECT counter FROM usercounter";
		$result = mysql_query($sql) or die();

		while ($row = mysql_fetch_array($result)) {
			$member_id_reference = $row['counter'];
		}
	}
?>

{!-- Paceholder for style change --}
<div id="friends_hide"><style></style></div>

{!-- Modal --}
<div data-swiftype-index="false" class="modal fade" id="worshipModal" tabindex="-1" role="dialog" aria-labelledby="worshipModalTitle" aria-hidden="true">
	<div class="modal-dialog modal-lg h-100 d-flex flex-column justify-content-center my-0" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="worshipModalTitle">Northland - Worship</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="modal-body">aaa
			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                {!-- <button type="button" class="btn btn-primary">Save changes</button>	--}
			</div>
		</div>
	</div>
</div>

{!-- Welcome Modal for Logged In user --}
<div data-swiftype-index="false" class="modal fade" id="welcomeLoggedInModal" tabindex="-1" role="dialog" aria-labelledby="welcomeLoggedInModalLabel" data-backdrop="static" data-focus="true" data-keyboard="false">
	<div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="welcomeModalLabel">Welcome back {screen_name}!</h4>
			</div>

			<div class="modal-body">
				<form id="welcomeLoggedIn" action="#" class="form-horizontal">
					<div class="form-group">
						<label for="num_worshipers" class="control-label">How many people are worshiping with you today?</label>
						<input type="number" class="form-control" id="num_worshipers" name="num_worshipers" required maxlength="3">
					</div>

					<div class="form-group">
						<button type="submit" class="btn btn-primary btn-block btn-lg" id="update_number_worshipers">Join</button>
					</div>

					<div id="welcomeLoggedIn_error" 	class="alert alert-danger" role="alert" style="display:none">
						Message for immediate attention.
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

{if group_id == "1" || group_id == "19" || group_id == "13"}
{!-- Minister/Admin Instructions Modal --}
<div data-swiftype-index="false" class="modal fade" id="ministerModal" tabindex="-1" role="dialog" aria-labelledby="ministerModal" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Online Minister Notes</h4>
            </div>
            <div class="modal-body">
                <p>
                    <strong>Welcome to the new online worship environment!</strong> 
                    Thank you for faithfully leading our congregation online. The community here could not
                    exist without all you do! A few things have changed, and we want you to know what those things are.
                    You can revisit this information any time in the top nav under "Minister Notes."
                </p>
                <ul class="list-group">
                    <li class="list-group-item">
                        <strong>1. "Chat" is now split into "Group Chat" and "Private Chat"</strong>
                    </li>
                    <li class="list-group-item">
                        <p><strong>2. "Group Chat" is in the same location and has an actions menu under each message</strong></p>

                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">Start private chat with worshiper</li>
                            <li class="list-group-item">Delete the message</li>
                        </ul>
                    </li>
                    <li class="list-group-item">
                        <strong>3. "Private Chat" is now at the bottom right of the screen.</strong><br>
                        Go here to start a private chat with individual worshipers.
                    </li>
                    <li class="list-group-item">
                        <strong>4. User profile and log out button</strong><br>
                        These are now under a user actions menu at the top right of the screen next to the Give button. Click on your name to access menu.
                    </li>
                    <li class="list-group-item">
                        <strong>5. All admin tools are at the top of page</strong><br>
                        This includes a link to the admin console, clearing the chat, turning on/off the service, and reloading the map.
                    </li>
                    <li class="list-group-item">
                        <strong>6. This is now mobile friendly!</strong><br>
                        This means all online worshipers can watch the video, chat, and access the other tools here from any mobile device.
                    </li>
                </ul>
                <p class="mt-3">
                    <strong>Have questions?</strong> Reach out on Slack - we're here to help!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{/if}

{!-- Welcome Modal --}
<div data-swiftype-index="false" class="modal fade" id="welcomeModal" tabindex="-1" role="dialog" aria-labelledby="welcomeModal" data-backdrop="static" data-focus="true" data-keyboard="false">
	<div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="welcomeModalLabel">Welcome to online worship at Northland!</h4>
			</div>

			<div class="modal-body">
				<div class="row">
					<div class="col-md-12 col-sm-12 mb-2">
						<button type="button" class="btn btn-primary btn-block btn-mixed btn-lg login-button" id="login-button">Click to log in with Northland</button>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12 col-sm-12">
						<button type="button" class="btn btn-secondary btn-block btn-mixed login-button-anonymous">Join worship without login</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

{!-- Welcome Modal for Not Logged In user --}
<div data-swiftype-index="false" class="modal fade" id="welcomeNotLoggedInModal" tabindex="-1" role="dialog" aria-labelledby="welcomeNotLoggedInModalLabel" data-backdrop="static" data-focus="true" data-keyboard="false">
	<div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="welcomeModalLabel">Welcome to online worship at Northland!</h4>
			</div>

			<div class="modal-body">
				<form id="welcomeNotLoggedIn" action="#" class="form-horizontal">
					<div class="form-group">
						<label for="name_worshipers" class="col-sm-12 control-label">Enter your name</label>
						<div class="col-sm-12">
							<input type="text" class="form-control" id="name_worshipers" name="name_worshipers" required maxlength="20">
						</div>
					</div>
					<div id="alert_enter_name" 		class="alert alert-warning" role="alert" style="display:none">Please enter a name to join worship.</div>
					<div id="alert_alphabet" 	class="alert alert-warning" role="alert" style="display:none">Please use letters and spaces.</div>
					<div id="multiple_username" 	class="alert alert-warning" role="alert" style="display:none">
						We found multiple accounts with your email address.
						Send an email to <a href="mailto:keehong.pang@northlandchurch.net">keehong.pang@northlandchurch.net</a> to fix this.
					</div>

					<div class="form-group">
						<label for="num_worshipers1" class="col-sm-12 control-label">How many people are worshiping with you today?</label>
						<div class="col-sm-12">
							<input type="number" class="form-control" id="num_worshipers1" name="num_worshipers1" required maxlength="3">
						</div>
					</div>

					<div id="welcomeNotLoggedIn_error" 	class="alert alert-danger" role="alert" style="display:none">
						Message for immediate attention.
					</div>

					<div class="form-group">
						<div class="col-sm-12">
							<button type="submit" class="btn btn-primary btn-block btn-lg" id="update_number_worshipers1">Join</button>
						</div>
					</div>
				</form>
			</div>

			<div class="modal-footer justify-content-start">
				<button type="button" class="btn btn-transparent btn-mixed welcome-button">< Back to log in</button>
			</div>
		</div>
	</div>
</div>

{!-- User Login Modal --}
<div data-swiftype-index="false" class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" data-backdrop="static" data-focus="true" data-keyboard="false">
	<div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="loginModalLabel">Sign In</h4>
			</div>

			<div class="modal-body">
				<div class="row">
					<div class="col-sm-12">
						<p>
						Click <a href="#" class="clickRegisterLink underline">here to create an account</a> or log in to your account below.
						</p>
					</div>
				</div>

				{exp:member:login_form form_class="login_form" id="Login" return="<?php echo $_SERVER['HTTP_REFERER']; ?>"}
					<div class="form-group row">
						<label for="username" class="col-sm-2 control-label">Email</label>
						<div class="col-sm-10">
							<input type="email" class="form-control" id="username" name="username">
						</div>
					</div>
					<div id="invalid_username" 	class="alert alert-warning" role="alert" style="display:none">
						We need a valid email to proceed.
					</div>
					<div id="noregister_username" 	class="alert alert-warning" role="alert" style="display:none">
						Your email address isn't in our system. 
						<a href="#" class="clickRegisterLink underline">Click here to create a new account.</a>
					</div>
					<div id="multiple_username" 	class="alert alert-warning" role="alert" style="display:none">
						We found multiple accounts with your email address. 
						Send us an Email to <a href="mailto:keehong.pang@northlandchurch.net">keehong.pang@northlandchurch.net</a> to fix this.
					</div>

					<div class="form-group row">
						<label for="password" class="col-sm-2 control-label">Password</label>
						<div class="col-sm-10">
							<input type="password" class="form-control"  name="password" id="password">
						</div>
					</div>
					<div id="incorrect_password" 	class="alert alert-warning" role="alert" style="display:none">
						<strong>Incorrect Password Entered</strong><br>
						<a href="#" id="reset_pw">Forgot your password? Have your password emailed to you.</a>
					</div>

					{!-- AUTO-LOGIN --}
					<div class="form-group row">
						<div class="col-sm-10 offset-sm-2">
							<input type="checkbox" class="form-check-input" name="auto_login" id="auto_login" checked />
							<label class="form-check-label" for="auto_login">Auto-login on future visit?</label>
						</div>
					</div>

					<div id="login_error" 	class="alert alert-danger" role="alert" style="display:none">
						Message for immediate attention.
					</div>

					<div class="form-group row">
						<div class="col">
							<button type="submit" class="btn btn-primary btn-block btn-lg">Log in</button>
						</div>
					</div>
				{/exp:member:login_form}
			</div>

			<div class="modal-footer justify-content-start">
                <button type="button" class="btn btn-transparent btn-mixed welcome-button">< Back to log in</button>
            </div>
		</div>
	</div>
</div>

{!-- User Registration Modal --}
<div data-swiftype-index="false" class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="registerModalLabel" data-backdrop="static" data-focus="true" data-keyboard="false">
	<div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" id="registerModalLabel">Create a New Account</h4>
			</div>

			<div class="modal-body">
				<form id="Register" action="#" class="">
					<div class="form-group row">
						<label for="username" class="col-sm-3 control-label">Email</label>
						<div class="col-sm-9">
							<input type="email" class="form-control" id="regusername" name="regusername" required maxlength="60">
						</div>
					</div>
					<div id="invalid_username" 		class="alert alert-warning" role="alert" style="display:none">We need a valid email to proceed.</div>
					<div id="registered_username" 	class="alert alert-warning" role="alert" style="display:none">Your email address is already registered. <a href="#" class="clickLoginLink underline">Click here to log in.</a></div>
					<div id="multiple_username" 	class="alert alert-warning" role="alert" style="display:none">
						We found multiple accounts with your email address. 
						Send us an Email to <a href="mailto:keehong.pang@northlandchurch.net">keehong.pang@northlandchurch.net</a> to fix this.
					</div>

					<div class="form-group row">
						<label for="firstname" class="col-sm-3 control-label">First Name</label>
						<div class="col-sm-9">
							<input type="text" class="form-control required" name="firstname" id="firstname" required maxlength="20">
						</div>
					</div>
					<div id="required_firstname" class="alert alert-warning" role="alert" style="display:none">Please enter your first name.</div>

					<div class="form-group row">
						<label for="lastname" class="col-sm-3 control-label">Last Name</label>
						<div class="col-sm-9">
							<input type="text" class="form-control required" name="lastname" id="lastname" required maxlength="20">
						</div>
					</div>
					<div id="required_lastname" class="alert alert-warning" role="alert" style="display:none">Please enter your last name.</div>

					<div class="form-group row">
						<label for="password" class="col-sm-3 control-label">Password</label>
						<div class="col-sm-9">
							<input type="password" class="form-control required-password"  name="regpassword" id="regpassword" required maxlength="20">
						</div>
					</div>
					<div id="errorlength_password" 	class="alert alert-warning" role="alert" style="display:none">Password must be at least 6 characters long.</div>
					<div id="errorcomb_password" 	class="alert alert-warning" role="alert" style="display:none">Password must contain at least one number, one lowercase and one uppercase letter.</div>

					<div class="form-group row">
						<label for="confirmpw" class="col-sm-3 control-label" style="line-height:1.2">Confirm Password</label>
						<div class="col-sm-9">
							<input type="password" class="form-control required-confirmpw"  name="confirmpw" id="confirmpw" required maxlength="20">
						</div>
					</div>
					<div id="error_confirmpw" class="alert alert-warning" role="alert" style="display:none">The Password does not match.</div>

					<input type="hidden" name="accept_terms" 	id="accept_terms" value="y"  />

					<div id="register_error" 	class="alert alert-danger" role="alert" style="display:none">
						Message for immediate attention.
					</div>

					<div class="form-group">
						<button type="submit" class="btn btn-primary btn-block btn-lg">Register</button>
					</div>
				</form>
			</div>

			<div class="modal-footer justify-content-start">
                <button type="button" class="btn btn-transparent btn-mixed welcome-button">< Back to log in</button>
            </div>
		</div>
	</div>
</div>

{!-- Share Email modal --}
<div data-swiftype-index="false" class="modal fade" id="inviteModal" tabindex="-1" role="dialog" aria-labelledby="inviteModal" data-backdrop="false" data-keyboard="true">
    <div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" role="document">
        <div id="online-invite" class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Invite someone to worship online</h4>
            </div>

            <form id="share_form">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="control-label">Sender Name: </label>
                        <input class="form-control" id="shareform_from_name" type="text" value='{if screen_name}{screen_name}{/if}'>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Sender E-mail: </label>
                        <input class="form-control" id="shareform_from_email" type="text" value='{if email}{email}{/if}'>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Recipient Name: </label>
                        <input class="form-control" id="shareform_to_name" type="text" value=''>
                    </div>
                    <div class="form-group">
                        <label>Recipient E-mail: </label>
                        <input class="form-control" id="shareform_to_email" type="text" value=''>
                    </div>
                    <div class="form-group">
                        <label>Personal Message: </label>
                        <textarea class="form-control" style="min-height: 100px; resize: none" id="shareform_message"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Nevermind</button>
                    <input class="btn btn-primary" class="btn btn-primary" type="submit" value="Send Invite">
                </div>
            </form>
        </div>
    </div>
</div>

{!-- Main Container --}
<div class="container-fluid" id="rootContainer">
	{if !logged_in}
        {!-- Used for profanity filter since filter can't update textbox directly --}
        <div id="anonymous_name" style="display: none"></div>
	{/if}

    <div class="row align-items-center">
        <div class="col-md-4">
            <a href="https://www.northlandchurch.net" target="_blank">
                <img class="logo" src="https://global-uploads.webflow.com/5a941dc804115100018caf6f/5b8ee9894180d57aa9ecd072_NACD_logo_primary1.png" alt="Northland Church" id="logo" srcset="https://global-uploads.webflow.com/5a941dc804115100018caf6f/5b8ee9894180d57aa9ecd072_NACD_logo_primary1-p-500.png 500w, https://global-uploads.webflow.com/5a941dc804115100018caf6f/5b8ee9894180d57aa9ecd072_NACD_logo_primary1-p-800.png 800w, https://global-uploads.webflow.com/5a941dc804115100018caf6f/5b8ee9894180d57aa9ecd072_NACD_logo_primary1-p-1080.png 1080w, https://global-uploads.webflow.com/5a941dc804115100018caf6f/5b8ee9894180d57aa9ecd072_NACD_logo_primary1.png 1230w" sizes="(max-width: 479px) 45vw, (max-width: 767px) 199.99998474121094px, 239.99998474121094px" data-w-id="d5887f25-8dbf-8252-bc25-ac42e920eef8" class="northland_logo northland_logo_black">
            </a>
        </div>
        <div class="col-md-8">
            <ul class="nav nav-flex-icons align-items-center float-md-right profile-wrapper">
                {if group_id == "1" || group_id == "19" || group_id == "13"}
                    <script type="text/javascript">
                        function AdminServiceLiveCheck() {
                            AdminUpdateServiceLiveCheck();
                            setTimeout("AdminServiceLiveCheck()", 20000);
                        }

                        function AdminUpdateServiceLiveCheck() {
                            $.ajax({
                                url: "/_component/isservicelive",
                                success: function(data) {
                                    if (data.indexOf("true") != -1) {
                                        $("#service_live").replaceWith("<a id='service_live' href='#' class='nav-link' onclick='confirm_turn_service_off()'>Service is currently LIVE</a>");
                                    }
                                    else {
                                        $("#service_live").replaceWith("<a id='service_live' href='#' class='nav-link' onclick='confirm_turn_service_on()'>Service is currently OFF</a>");
                                    }
                                }
                            });
                        }

                        function confirm_turn_service_on() {
                            var r=confirm("Are you sure you want to turn service ON");
                            if (r==true) {
                                $.ajax({
                                    url: "/_component/change_servicelive/on/"
                                }).done(function() { AdminUpdateServiceLiveCheck(); });
                            }
                        }

                        function confirm_turn_service_off() {
                            var r=confirm("Are you sure you want to turn service OFF");
                            if (r==true) {
                                $.ajax({
                                    url: "/_component/change_servicelive/off/"
                                }).done(function() { AdminUpdateServiceLiveCheck(); });
                            }
                        }

                        function reload_map() {
                            initMap();
                        }
                    </script>

                    <li class="nav-item">
                        <a href="#" class="nav-link" data-toggle="modal" data-target="#ministerModal">Minister Notes</a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin" class="nav-link" target="_blank">Admin Console</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" id="service_live" class="nav-link"></a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="ClearGroupChat()">Clear Chat</a>
                    </li>
                    <li class="nav-item mr-3">
                        <a id="reload_map" class="nav-link" href='#' onclick='reload_map()'>Reload Map</a>
                    </li>
                {/if}

                {!-- Give Button for tablet and up --}
                <li class="nav-item d-none d-md-inline">
                    <a class="nav-link btn btn-give" href='https://www.northlandchurch.net/give' target="_blank">Give ></a>
                </li>

                {!-- Section for Profile --}
                {if logged_in}
                    <li class="nav-item dropdown nav-item--user">
                        <a class="nav-link dropdown-toggle" id="profile-info" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            <img id="profile-avatar-img" src="/images/member_photos/50x50/photo_{member_id}.jpg" onerror="this.src='/images/avatar.png'" class="z-depth-0 mr-2" alt="Avatar" height="50">
                            <span><strong>{screen_name}</strong></span>
                            {!-- <span id="profile-location">Longwood Oviedo Winter Springs, Florida</span> --}
                        </a>
                        <div class="dropdown-menu dropdown-menu-right dropdown-info" aria-labelledby="profile-info">
                            <a class="dropdown-item" href="/profile" target="_blank">My Profile</a>
                            <a class="dropdown-item" href="#" onclick="logoutandreload(); return false;">Log Out</a>
                        </div>
                    </li>
                {if:else}
                    <li class="nav-item dropdown nav-item--user">
                        <a class="nav-link dropdown-toggle" id="profile-info" href="#login-register-box" data-toggle="modal" data-target="#loginModal">
                            <img id="profile-avatar-img" src="/images/avatar.png" class="z-depth-0" alt="Avatar" height="50">
                            <span><strong>Log In</strong></span>
                        </a>
                    </li>

                    {!-- <div id='profile-notsignedin-welcome' class='profile-header'>Welcome to Northland Online Worship</div>
                    <div id="profile-location" style="display:none"></div>

                    <div class="rostermessage">Please <a class="user-login" href="#login-register-box" style="text-decoration:underline" data-toggle="modal" data-target="#loginModal">login</a> to access additional features like, Request Prayer, Read the Bible and more.</div> --}
                {/if}

                {!-- Give Button for mobile --}
                <li class="nav-item d-md-none d-sm-inline float-right nav-item--give">
                    <a class="nav-link btn btn-give" href='https://www.northlandchurch.net/give' target="_blank">Give ></a>
                </li>
            </ul>
        </div>
    </div>

	<div id="worship-contain" class="d-lg-flex flex-row align-items-stretch">
		{!-- Worship video section	--}
		<div class="col-lg-7 alpha worship-contain--col">

            {!-- Share for mobile only --}
            <div class="d-md-none mb-3">
                <h5 class="sidebar-heading-h3 float-left mr-3 mt-2">Share</h5>
                <div class="share-button facebook w-embed float-left mr-2">
                    <a onclick="window.open(this.href, 'twitter-share','width=580,height=296');return false;" href="http://www.facebook.com/sharer/sharer.php?u=https://www.northlandchurch.church/worship">
                        <div>
                            <img src="https://assets-global.website-files.com/5a941dc804115100018caf6f/5b3aa0277b1e3f30e2956237_Facebook-icon.svg">
                        </div>
                    </a>
                </div>
                <div class="share-button twitter w-embed float-left mr-2">
                    <a onclick="window.open(this.href, 'twitter-share','width=580,height=296');return false;" href="http://twitter.com/share?url=https://www.northlandchurch.church/worship&amp;text=Worship with me at Northland Church online. @northlandchurch">
                        <div>
                            <img src="https://assets-global.website-files.com/5a941dc804115100018caf6f/5b3aa027fa3b00444b6fad46_Twitter-icon.svg">
                        </div>
                    </a>
                </div>
                <div class="share-button email w-embed float-left">
                    <a href="#" data-toggle="modal" data-target="#inviteModal">
                        <div>
                            <img src="https://assets-global.website-files.com/5a941dc804115100018caf6f/5b989285c0576809e458a7c8_email.svg">
                        </div>
                    </a>
                </div>
                <div class="clear"></div>
            </div>

			<div id="onlineworship-video">
                {!-- WORSHIP VIDEO --}
                {if service_live=="true"}
					<div class="responsive-video-player" id="media_iframe">
						<iframe src="//player.streammonkey.com/iframe/REUQk4eV" width="100%" height="100%" frameborder="0" allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>
					</div>
			    {if:else}
					<div class="responsive-video-player">
						<iframe id="vimeo_player" width="640" height="360" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
					</div>
				{/if}
            </div>

            <div class="onlineworship-info">
                <div class="float-left w-100">
                    {if service_live != "true"}
                        <h3 class="pt-3">
                            Welcome to online worship at Northland!
                        </h3>
                        <p>
                            We currently aren't in live worship, but you can watch the latest worship service here.
                        </p>
                        {exp:channel:entries channel="media" category="48" limit="1" dynamic="off"}
                        <p class="pb-3">
                            <strong>JOIN US LIVE:</strong> {service_times_singleline}
                        </p>
                        {/exp:channel:entries}
                    {/if}

                    {if service_live == "true"}
                        <div class="alert alert-secondary" role="alert">
                            Having video problems? <br class="d-md-none"><span id="backup-replace"><a href="#" onclick="LoadYoutube(); return false;" class="underline">Click here to use our backup stream.</a></span>
                        </div>

                        <?php if (({current_time format="%G%i"} > 430) && ({current_time format="%G%i"} < 1000)) : ?>
                            <div id="translations" class="translations">
                                <strong>TRANSLATION:</strong> 
                                <a href="#" id="translation_english" onclick="LoadEnglish(); return false;" class="d-block d-md-inline btn btn-primary btn-sm" disabled>English</a> 
                                <a href="#" id="translation_spanish" onclick="LoadSpanish(); return false;" class="d-block d-md-inline btn btn-secondary btn-sm">Espanol</a> 
                                {!-- <a href="#" type="button" id="translation_deaf"    onclick="LoadDeaf(); return false;" 	  class="d-block d-md-inline btn btn-secondary btn-sm disabled" disabled>Interpreted for the Deaf and Hard of Hearing</a> --}
                            </div>
                        <?php endif; ?>

                        <?php if (({current_time format="%G%i"} > 1020) && ({current_time format="%G%i"} < 1330)) : ?>
                            <div id="translations" class="translations">
                                <strong>TRANSLATION:</strong>
                                <a href="#" id="translation_english" onclick="LoadEnglish(); return false;" class="d-block d-md-inline btn btn-primary btn-sm" disabled>English</a> 
                                <a href="#" id="translation_spanish" onclick="LoadSpanish(); return false;" class="d-block d-md-inline btn btn-secondary btn-sm" >Espanol</a> 
                                <a href="#" id="translation_deaf"    onclick="LoadDeaf(); return false;" 	  class="d-block d-md-inline btn btn-secondary btn-sm" >Interpreted for the Deaf and Hard of Hearing</a>
                            </div>
                        <?php endif; ?>

                        <?php if (({current_time format="%G%i"} > 1630) && ({current_time format="%G%i"} < 2100)) : ?>
                            {!-- <div id="translations" class="translations">
                                <strong>TRANSLATION:</strong>
                                <a href="#" type="button" id="translation_english" onclick="LoadEnglish(); return false;" class="d-block d-md-inline btn btn-secondary btn-sm disabled" disabled>English</a> 
                                <a href="#" type="button" id="translation_spanish" onclick="LoadSpanish(); return false;" class="d-block d-md-inline btn btn-secondary btn-sm disabled" disabled>Espanol</a> 
                                <a href="#" type="button" id="translation_deaf"    onclick="LoadDeaf(); return false;" 	  class="d-block d-md-inline btn btn-secondary btn-sm disabled" disabled>Interpreted for the Deaf and Hard of Hearing</a>
                            </div> --}
                        <?php endif; ?>

                        <div id="current-viewers" class="below_videotab">Current Viewers: </div>
                        {!-- Button trigger modal --}
                        <button id="btn1" type="button" class="btn btn-primary" data-toggle="modal" data-target="#worshipModal" style="display:none">Launch Worship Modal</button>
                    {/if}
                </div>

                <div class="onlineworship-social float-right d-none d-md-flex">
                    <h3 class="sidebar-heading-h3">Share</h3>
                    <div class="share-button facebook w-embed">
                        <a onclick="window.open(this.href, 'twitter-share','width=580,height=296');return false;" href="http://www.facebook.com/sharer/sharer.php?u=https://www.northlandchurch.church/worship">
                            <div>
                                <img src="https://assets-global.website-files.com/5a941dc804115100018caf6f/5b3aa0277b1e3f30e2956237_Facebook-icon.svg">
                            </div>
                        </a>
                    </div>
                    <div class="share-button twitter w-embed">
                        <a onclick="window.open(this.href, 'twitter-share','width=580,height=296');return false;" href="http://twitter.com/share?url=https://www.northlandchurch.church/worship&amp;text=Worship with me at Northland Church online. @northlandchurch">
                            <div>
                                <img src="https://assets-global.website-files.com/5a941dc804115100018caf6f/5b3aa027fa3b00444b6fad46_Twitter-icon.svg">
                            </div>
                        </a>
                    </div>
                    <div class="share-button email w-embed">
                        <a href="#" data-toggle="modal" data-target="#inviteModal">
                            <div>
                                <img src="https://assets-global.website-files.com/5a941dc804115100018caf6f/5b989285c0576809e458a7c8_email.svg">
                            </div>
                        </a>
                    </div>
                </div>

                <div class="clear"></div>
            </div>
		</div>
		<div class="col-lg-5 omega worship-contain--col">
			<nav class="tab-nav">
				<div class="nav nav-tabs nav-pills nav-justified justify-content-center" role="tablist">
					<a class="d-flex justify-content-center align-items-center nav-item nav-link active" id="map-tab" data-toggle="tab" href="#map" role="tab" aria-controls="map" aria-selected="true">Map</a>
                    {!-- <a class="d-flex justify-content-center align-items-center nav-item nav-link" id="notes-tab" data-toggle="tab" href="#notes" role="tab" aria-controls="notes" aria-selected="false">Notes</a>	--}
					<a class="d-flex justify-content-center align-items-center nav-item nav-link" id="chat-tab" data-toggle="tab" href="#chat" role="tab" aria-controls="chat" aria-selected="false">Group Chat</a>
                    <a class="d-flex justify-content-center align-items-center nav-item nav-link" id="guide-tab" data-toggle="tab" href="#guide" role="tab" aria-controls="guide" aria-selected="false">Worship Guide</a>
                    <a class="d-flex justify-content-center align-items-center nav-item nav-link" id="give-tab" data-toggle="tab" href="#give" role="tab" aria-controls="give" aria-selected="false">Give</a>
				</div>
			</nav>

			<div class="tab-content">
                {!-- TAB: Map --}
				<div class="tab-pane fade show active" id="map" role="tabpanel" aria-labelledby="map-tab"></div>

                {!-- TAB: Notes --}
				{!-- <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
					Notes
				</div> --}

                {!-- TAB: Chat --}
				<div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
					<div class="row">
						<div class="col">
							<div id="chat-field-box">
								<form name="chatform" id="group_chat_form">
									<div class="form-row search-form">
										<div class="form-group col-md-10 col-sm-9 mb-0">
											<input type="text" id="groupchat_field" class="form-control groupchat-input" placeholder="Enter your message..." style="font-size: 0.8rem;">
										</div>
										<div class="form-group col-md-2 col-sm-3 mb-0">
											<button type="submit" class="btn btn-secondary w-100 groupchat-input">Send</button>
										</div>
									</div>
								</form>
                            </div>

                            <div id="chat-box-list"></div>
						</div>
					</div>
                </div>

                {!-- TAB: Worship Guide --}
                <div class="tab-pane fade" id="guide" role="tabpanel" aria-labelledby="guide-tab" style="text-align: center"></div>

                {!-- TAB: Give --}
				<div class="tab-pane fade" id="give" role="tabpanel" aria-labelledby="give-tab">
                    <div class="giving-form">
                        <h4>Why We Give</h4>
                        <p>
                            God has demonstrated grace to us, giving us what we don’t deserve and can never earn. 
                            In this same way, in all areas of our lives—with our time, our energy and our 
                            resources—we can demonstrate His grace toward those around us.
                        </p>
                        <p>
                            <a href="https://www.northlandchurch.net/series/life-giving-generosity" target="_blank" class="underline">Check out our sermon series on generosity ></a>
                        </p>
                            At Northland, your gifts contribute to the cultivation of environments in which God is worshiped, 
                            the gospel is taught, relationships are built, people are served and the footprint of His Kingdom is expanded.
                        </p>
                        <p>
                            <a href="https://northlandchurch.church/2018/" target="_blank" class="underline">See how God is using Northland in this community ></a>
                        </p>
                        <form id="giving-form" class="mt-4">
                            <div id="amount" role="group" class="form-group">
                                <h4>Give Now</h4>
                                <p>Amount:</p>
                                <div>
                                    <input name="amount" type="number" required="required" aria-required="true" class="form-control">
                                </div>
                            </div>
                            <div role="group" class="form-group">
                                <p>Fund:</p>
                                <select class="form-control" name="fund">
                                    <option value="0">General Fund</option>
                                    <option value="1">Missions</option>
                                    <option value="2">Disaster Response</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary mt-3">Continue</button>
                        </form>
                    </div>
                </div>
			</div>
		</div>
	</div>

	<div id="alert-container"></div>

	<div id="chat-bar">
        <div id="chat-slider-container">
            <div id="chat-tab-bar">
                <div id="chat-left" style="display:none; ">&lt;&lt;</div>
                <div id="chat-right" style="display:none;">&gt;&gt;</div>
                <ul id="chat-slider-ul"></ul>
            </div>

            <div class="btn-group dropup float-right private-chat">
                <button type="button" class="btn btn-primary dropdown-toggle private-chat--btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Private Chat
                </button>
                <div class="dropdown-menu pt-0 private-chat--list">
                    {!-- Section for Search bar --}
                    <div id="search-box" class="chat-search-box">
                        <form name="search_people" id="search_people">
                            <div class="form-row search-form">
                                <div class="form-group col mb-0">
                                    <input type="text" id="filter-search" class="form-control" placeholder="Enter name to search people..." style="font-size: 0.8rem;">
                                </div>
                            </div>
                        </form>
                    </div>

                    {!-- Section for Roster Stack --}
                    <div>
                        <div id="chat-disconnected" class="rostermessage">Chat loading...<br>Refresh your browser if Chat does not load within a couple of minutes.</div>
                        <div id="chatroster" class="custom_scrollbar chatroster-list">
                            <div id="minister"></div>
                            <div id="host"></div>
                            <div id="tech-support"></div>
                            <div id="people"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
	</div>
</div>

{!-- Optional JavaScript --}
{!-- jQuery first, then Popper.js, then Bootstrap JS --}
{!--    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>	--}
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script src="/_assets/onlineworship/markerclusterer/markerclusterer.1.0.3.js"></script>
{!--
<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAENRWzgvgTgrR26OuYWTinEIbs8Ik1UDw&callback=initMap">
</script>
--}

{!-- MaxMind to get user Geolocation --}
<script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>

{!-- Node Chat --}
<script src="/_assets/onlineworship/socket.io.js"></script>
<script src="/_assets/onlineworship/handlebars-v4.1.2.js"></script>
<script src="/_assets/onlineworship/moment.2.24.0.min.js"></script>


{!-- Adaptive textarea code --}
<script type="text/javascript" src="/_assets/onlineworship/autosize.min.js"></script>
<script type="text/javascript" src="/_js/jquery.profanityfilter.min.js"></script>

<script>
var map;
var markerCluster;
var markersArray = {};

var infobox_options;
var infoWindow;

function initMap() 
{
	var mapOptions = {
		zoom: 7,
		minZoom: 1,
		maxZoom: 15,
		scrollwheel: false,
		center: new google.maps.LatLng(28.684922, -81.336486),
//		center: new google.maps.LatLng(-25.363, 131.044),
		mapTypeId: google.maps.MapTypeId.TERRAIN,
		streetViewControl: false,
		panControl: false,
		overviewMapControl: false,
        mapTypeControl: false,
        styles: [
            {
                "featureType": "all",
                "elementType": "all",
                "stylers": [
                    {
                        "saturation": "32"
                    },
                    {
                        "lightness": "-3"
                    },
                    {
                        "visibility": "on"
                    },
                    {
                        "weight": "1.18"
                    }
                ]
            },
            {
                "featureType": "administrative",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "landscape",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "landscape.man_made",
                "elementType": "all",
                "stylers": [
                    {
                        "saturation": "-70"
                    },
                    {
                        "lightness": "14"
                    }
                ]
            },
            {
                "featureType": "poi",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "transit",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "all",
                "stylers": [
                    {
                        "saturation": "100"
                    },
                    {
                        "lightness": "-14"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "labels",
                "stylers": [
                    {
                        "visibility": "off"
                    },
                    {
                        "lightness": "12"
                    }
                ]
            }
        ]
	};
	map = new google.maps.Map(document.getElementById('map'), mapOptions);

	infoWindow = new google.maps.InfoWindow({
	});

	// Add a marker clusterer to manage the markers.
	var clusterOptions = {
		zoomOnClick: false,
		minimumClusterSize: 1,
		imagePath: '/_assets/onlineworship/markerclusterer/m'
	};
	markerCluster = new MarkerClusterer(map, [], clusterOptions);


	google.maps.event.addListener(map, 'zoom_changed', function() { infoWindow.close(); });
	google.maps.event.addListener(map, 'clusterclick', function(markercluster) { ClusterClicked(markercluster) });

	setTimeout("StartMapUpdateCycle()", 15000);

}


function AddMarker(chatid, lat, lng) 
{
	if (lat && lng && lat != 0 && lng != 0) 
	{
		markersArray[chatid] = new google.maps.Marker({position: new google.maps.LatLng(lat,lng), title: chatid.toString()});
	}
}

// Removes marker from map when user leaves
function RemoveMarker(chatid) 
{
	delete markersArray[chatid];
}


function InfoWindowClose() 
{
	infoWindow.close();
}


////////////////////////////////////////////////////////////////////////
// Event handler when clicks Marker Cluster
// Opens an InfoWindow
////////////////////////////////////////////////////////////////////////
function ClusterClicked(markercluster) 
{
	var cluster_markers = [];
	infoWindow.close();

	cluster_markers = markercluster.getMarkers(); // Get markers managed by cluster
	map.panTo(markercluster.getCenter());

	var dom_id;

	html_content = 	"<div id='infowindow'>";
	for (var i = 0; i < cluster_markers.length; i++) 
	{
		var userinfo = usersArray[cluster_markers[i].getTitle()];

		if (userinfo) 
		{
			if (userinfo.role) {
				html_content += "<div class='infowindow_name'>" + 
									"<img class='infowindow_profile_avatar' src='" + userinfo.photourl + "' onerror=\"this.src='/images/avatar.png'\"/>" +
									"<a class='map_link' onclick=\"ShowInfoWindowProfile(" + userinfo.uid + ")\">" + userinfo.fullname + "</a>";
			}
			else {
				html_content += "<div class='infowindow_name'>" + 
									"<img class='infowindow_profile_avatar' src='/images/avatar.png' />" + 
									"" + userinfo.fullname;
			}

			if (userinfo.uid != <?php echo $member_id_reference; ?> && userinfo.uid != 'anon_<?php echo $member_id_reference; ?>') {
				dom_id = userinfo.uid + "_" + userinfo.fullname.split(' ').join('_');

				html_content += " - <a class='map_link' onclick=\"StartPrivateChat('" + userinfo.uid + "', '" + userinfo.fullname + "')\">Chat</a>";
			}
			else {
				html_content += " - You"; 
			}

			if (userinfo.groupsize > 1) {
				html_content += " (" + userinfo.groupsize + " viewers)";
			}
			html_content += "</div><div class='infowindow_multiple_profile' id='infowindow_multiple_profile" + userinfo.uid +"'></div>";
		}
	}

	html_content += "</div>";

	infoWindow.setContent(html_content);
	infoWindow.setPosition(markercluster.getCenter());
	infoWindow.open(map);
}


////////////////////////////////////////////////////////////////////////
// Event Handler when clicks Username in the Map
////////////////////////////////////////////////////////////////////////
function ShowInfoWindowProfile(uid) 
{
	var html_content =	"<div class='infowindow_profile_show'>" + 
							"<div id='infowindow_profile" + uid + "'></div>" +
							"<div class='infowindow_prayer_header'>Prayer Requests</div>" +
							"<div id='infowindow_prayer_body" + uid + "'></div>" +
						"</div>";

	$("#infowindow_multiple_profile" + uid).empty().append(html_content);

	$.ajax({
		url: '/_component/get-latestprayer/' + uid,
		success: function(data) {
			if (data != '') { $("#infowindow_prayer_body" + uid).empty().append(data); }
			else { $("#infowindow_prayer_body" + uid).empty().append('No recent prayer requests'); }
			}
	});

	$.ajax({
		url: '/_component/get-profilebio/' + uid,
		success: function(data) {
			if (data != '') { $("#infowindow_profile" + uid).empty().append(data); }
			else { $("#infowindow_profile" + uid).empty().append('No user profile posted');	}
			}
	});

	if ($("#infowindow_multiple_profile" + uid).hasClass("infowindow_visible")) {
		$('.infowindow_multiple_profile').hide().removeClass("infowindow_visible");
	}
	else {
		$('.infowindow_multiple_profile').hide().removeClass("infowindow_visible");
		$("#infowindow_multiple_profile" + uid).addClass("infowindow_visible").show();
	}
}


// Event handler, run when user pans/zooms Google Map
function UpdateViewport()
{
	var i = 0;
	var viewportusers_array = [];
	var html_content = "";

	for (key in markersArray) 
	{
		viewportusers_array.push(markersArray[key]);
	}
	markerCluster.clearMarkers(); // Update MarkerClusterer
	markerCluster.addMarkers(viewportusers_array);
}


function StartMapUpdateCycle() 
{
	UpdateViewport();
	setTimeout("StartMapUpdateCycle()", 30000);
}



function UpdateClientLocation() 
{
	$("#profile-location").html(client_location);

	if (socket && socket.connected) {
		{if logged_in}
			socket.emit('update user', { latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize });
		{if:else}
			socket.emit('update user', { latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize });
		{/if}
	}

	UpdateMyUserInfo();
}
</script>

<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAENRWzgvgTgrR26OuYWTinEIbs8Ik1UDw&callback=initMap">
</script>

{!-- Template for Private Chat Roster Stack --}
<script type="text/x-handlebars-template" id="rosteruser_html">
    <div id='worshiper{{chatid}}' class='person {{#ifCond usertype "minister"}}online-minister {{/ifCond}} {{#ifCond usertype "host"}}online-minister {{/ifCond}} notfriend {{#handlebars_if usertype}}signedin{{else}}notsignedin{{/handlebars_if}}'>
        <div class="groupchat-avatar">
            <div class="groupchat-avatar--bg">
                <img src="{{photourl}}" onerror="this.src='/images/avatar.png'" width="45" height="45">
            </div>
        </div>

        <div class="groupchat-message--contain">
            <div class="groupchat-message--info">
                <div class="groupchat-message--controls">
                    {!-- Profile button but since most havent stayed up to date, removing for now
                        {if group_id == "1" || group_id == "19"}
                            {{#handlebars_if usertype}}<a href="#" class="person-link btn btn-sm btn-dark" onclick="clickProfileExpand(this, 'profile{{chatid}}', {{chatid}})">Profile</a>{{/handlebars_if}}
                        {/if}
                    --}
                    <a href="#" class="person-link person-link--chat btn btn-sm btn-dark private_link_{{chatid}}" onclick="StartPrivateChat('{{chatid}}', '{{name}}')">Chat</a>
                </div>

                <div class="groupchat-message--name">
                    <div id="fullname_{{chatid}}" class="privatechat-roster--name">
                        {{name}}{{#ifCond usertype "minister"}} - Minister{{/ifCond}}{{#ifCond usertype "host"}} - Host{{/ifCond}}{{#ifCond usertype "support"}} - Tech Support{{/ifCond}}
                    </div>
                </div>

                <div class="groupchat-message--loc">
                    <p id="address{{chatid}}" class="notupdatedaddress rosteraddress mb-0">
                        {{#handlebars_if loc}}{{loc}}{{else}}&nbsp;{{/handlebars_if}}
                    </p>
                    {if group_id == "1" || group_id == "19"}
                        {{#handlebars_if email}}<a href="mailto:{{this.email}}" class="underline" target="_blank">{{this.email}}</a>{{/handlebars_if}}
                    {/if}
                </div>
                <div class="groupchat-message--content">
                    <p>{{{message}}}</p>

                    {{#handlebars_if usertype}}
                        <div class="mini-profile profile{{chatid}}" style="display: none">
                            <div class="header">About {{name}}</div>
                            <div class="body" id="profile-text{{chatid}}"></div>
                            <div class="header">Prayer Requests</div>
                            <div class="body" id="prayer-text{{chatid}}"></div>
                        </div>
                    {{/handlebars_if}}
                </div>
                <div class="clear"></div>
            </div>
            <div class="clear"></div>
        </div>
    </div>
</script>

{!-- Template for Group Chat --}
<script type="text/x-handlebars-template" id="groupmessage_html">
    <div class="groupchat" id="groupmessage_{{id}}">
        <div class="groupchat-main">
            <div class="groupchat-avatar">
                <div class="groupchat-avatar--bg">
                    <img src="{{photourl}}" width="45" height="45" onerror="this.src='/images/avatar.png'">
                </div>

                <div class="groupchat-message--time">
                    {{dateFormat}}
                </div>
            </div>
            <div class="groupchat-message--contain">
                <div class="groupchat-message--info">
                    <div class="groupchat-message--controls">
                        {if group_id == "1" || group_id == "19" || group_id == "13"}
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Actions
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a class="pointer dropdown-item private_link_{{chatid}}" onclick="StartPrivateChat('{{chatid}}', '{{nickname}}')" {{#handlebars_if user_online}}{{else}}style="display:none"{{/handlebars_if}}>Chat</a>
                                    <a href="#" class="dropdown-item" onclick="RemoveGroupMessage('{{id}}')">Delete</a>
                                </div>
                            </div>
                        {if:else}
                            <a class="person-link btn btn-sm btn-dark private_link_{{chatid}}" onclick="StartPrivateChat('{{chatid}}', '{{nickname}}')" {{#handlebars_if user_online}}{{else}}style="display:none"{{/handlebars_if}}>Chat</a>
                        {/if}
                    </div>
                    <div class="groupchat-message--name pb-1">
                        {{nickname}}{{#ifCond usertype "minister"}} - Minister{{/ifCond}}{{#ifCond usertype "host"}} - Host{{/ifCond}}{{#ifCond usertype "support"}} - Tech Support{{/ifCond}}
                    </div>
                    <div class="groupchat-message--content">
                        <p>{{{message}}}</p>
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="clear"></div>
            </div>
        </div>
    </div>
</script>

{!-- Template for Private Chat Container --}
<script type="text/x-handlebars-template" id="privatecontainer_html">
    <li id="privatecontainer_{{chatid}}" class="single-chat selected">
        <div class="chat-tab tab-selected" id="tab{{chatid}}" style="display:block">{{tabnickname}}</div>

        <div class="single-chat-window" id="div{{chatid}}" style="display: block;">
            <div class="single-chat-header" id="chat-header{{chatid}}">
                {if group_id == "1" || group_id == "19" || group_id == "13"}
                    {{#ifCond is_img true}}
                        <div class="groupchat-avatar groupchat-avatar--mini">
                            <div class="groupchat-avatar--bg">
                                <img src="{{img}}" width="45" height="45">
                            </div>
                        </div>
                    {{/ifCond}}
                {/if}
                <h1>{{nickname}}</h1>
                <a class="chat-close" href="javascript:ClosePrivateChat('{{chatid}}')">X</a>
                {if group_id == "1" || group_id == "19" || group_id == "13"}
                    {{#ifCond is_local true}}
                        <br>
                        <p class="mb-0"><small>{{local}}<small></p>
                    {{/ifCond}}
                {/if}
                <div class="clear"></div>
            </div>

            <div id="pchatbox">
                <div class="pchatbox-inside">
                    <div id="privatemessages_{{chatid}}" class="chatbox" style="overflow-y: scroll; word-wrap: break-word; width: auto; height: 250px;"></div>
                </div>
            </div>

            <form class="panel-footer private_form" id="private_form_{{chatid}}">
                <textarea id="private_chatfield_{{chatid}}" class="pchatmsgbox" style="word-wrap: break-word;"></textarea>
            </form>
        </div>
    </li>
</script>

{!-- Template for Private Chat Message --}
<script type="text/x-handlebars-template" id="privatemessage_html">
	{{#handlebars_if mine}}
		<div class="pmsg pmsg_me_bg">
			<div class="pmsg_body_container">
				<p class="pmsg_body">{{{message}}}</p>
			</div>
			<div class='pmsg_avatar right_avatar'>
				<img class='pmsg_right_avatar' height='40' width='40' src='{{photourl}}' onerror="this.src='/images/avatar.png'">
				{{dateFormat}}
			</div>
		</div>
	{{else}}
		<div class="pmsg pmsg_you_bg">
			<div class="pmsg_avatar left_avatar">
				<img class="pmsg_left_avatar" height="40" width="40" src="{{photourl}}" onerror="this.src='/images/avatar.png'">
				{{dateFormat}}
			</div>
			<div class="pmsg_body_container">
				<p class="pmsg_body">{{{message}}}</p>
			</div>
		</div>
	{{/handlebars_if}}
</script>

{if service_live == "true"}

{if:else}
    <script type="text/javascript">
    $(document).ready(function() {
        $.ajax({
            url: '/_component/webflow_resources/'
        }).done(function(data) {
            var parts = data.split("/"),
            last_part = parts[parts.length-1],
            vimeo_id = "https://player.vimeo.com/video/" + last_part + "?title=true";
            $('#vimeo_player').attr('src', vimeo_id);
        });
    });
    </script>
{/if}

<script type="text/javascript">
    var socket = null;
    var client_location;
    var client_latitude;
    var client_longitude;
    var first_connection = true;		// Flag for first connection to get group messages
    var duplicate_connection = false;	// Disconnected because of new user joining
    var logged_in_groupsize = 1; 		// Groupsize for current user, if hasn't clicked modal yet is stored as 0
    var usersArray = {};
    var list_toggle = 'everyone';

    {if logged_in}
        {exp:member:custom_profile_data}
            {if city != ""}
                {if countrycode != ""}
                    {if countrycode == "US"}
                        client_location = "{city}, {state}";
                    {if:else}
                        {if city != ""}
                            client_location = "{city}, {country}";
                        {if:else}
                            client_location = "{country}";
                        {/if}
                    {/if}
                {if:else}
                    {if state != ""}
                        client_location = "{city}, {state}";
                    {if:else}
                        client_location = "{city}";
                    {/if}
                {/if}
            {if:else}
                client_location = "{exp:low_replace find='/[^a-z^A-Z\,\s]/' regex='yes'}{location}{/exp:low_replace}";
            {/if}
        {/exp:member:custom_profile_data}
    {if:else}
        client_location = "";
    {/if}



    //////////////////////////////////////////////////////////////////////////////////////////////////////
    // 		GEO Location Functions
    //////////////////////////////////////////////////////////////////////////////////////////////////////
    function initiate_geolocation()
    {
        if (navigator.geolocation)
        {
            // Comment out due to the error from Google geolocation function
            // navigator.geolocation.getCurrentPosition(handle_geolocation_query, handle_geolocation_error, {maximumAge: 600000, timeout:1000});
            geoip2.city(onSuccess, onError);
        }
        else
        {
            geoip2.city(onSuccess, onError);
        }

        $("#profile-location").html(client_location);
    }


    var onSuccess = function(location) {
        client_latitude = location.location.latitude;
        client_longitude = location.location.longitude;

        if (location.country.iso_code == "US")
        {
            if (location.city.names.en !== undefined) {
                client_location = location.city.names.en + ", " + location.subdivisions[0].names.en;
            } else {
                client_location = location.subdivisions[0].names.en;
            }
        }
        else
        {
            if (location.city.names.en !== undefined) {
                client_location = location.city.names.en + ", " + location.country.names.en;
            } else {
                client_location = location.country.names.en;
            }
        }

        UpdateClientLocation();
    };

    var onError = function(error){
        console.error("Error getting MaxMind location");
    };

    /*
    function handle_geolocation_query(position)
    {
        client_latitude = position.coords.latitude.toFixed(4);
        client_longitude = position.coords.longitude.toFixed(4);

        {if '{exp:member:custom_profile_data}{manual_city_state}{/exp:member:custom_profile_data}' != "Yes"}
            client_location = "";
            UpdateClientLocation();

    //		$.get("/scripts/getcityfromlatlng.php/?lat=" + client_latitude + "&lng=" + client_longitude, function(data) {
    //			client_location = data;
    //			console.log("getcityfromlatlng() location: " + client_location);
    //			UpdateClientLocation();
    //		});

        {if:else}
            var geocoder = new google.maps.Geocoder();
            client_location	= '{location}';
            geocoder.geocode( { 'address': client_location}, function(results, status) {
                var location 		= results[0].geometry.location;
                client_latitude		= location.lat();
                client_longitude	= location.lng();
                UpdateClientLocation();
            });
        {/if}

        if (map) {
            map.panTo(new google.maps.LatLng(client_latitude, client_longitude));
        }
    }

    function handle_geolocation_error(error)
    {
        {if '{exp:member:custom_profile_data}{manual_city_state}{/exp:member:custom_profile_data}' != "Yes"}
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    console.warning("User denied the request for Geolocation.");
                    geoip2.city(onSuccess, onError);
                    break;
                case error.POSITION_UNAVAILABLE:
                    console.warning("Location information is unavailable.");
                    geoip2.city(onSuccess, onError);
                    break;
                case error.TIMEOUT:
                    console.warning("The request to get user location timed out.");
                    geoip2.city(onSuccess, onError);
                    break;
                case error.UNKNOWN_ERROR:
                    console.error("An unknown error occurred.");
                    geoip2.city(onSuccess, onError);
                    break;
                default:
                    console.error("Undefined error.");
                    break;
            }
        {if:else}
            var geocoder = new google.maps.Geocoder();
            client_location	= '{location}';
            console.log("Manual: " + client_location);
            geocoder.geocode( { 'address': client_location}, function(results, status) {
                var location 		= results[0].geometry.location;
                client_latitude		= location.lat();
                client_longitude	= location.lng();
                console.log('LAT: ' + location.lat() + ' LANG: ' + location.lng());
                UpdateClientLocation();
            });
        {/if}
    }
    //function handle_geolocation_error(error) { }
    */

    //////////////////////////////////////////////////////////////////////////////////////////////////////
    // 		End for GEO Location Functions
    //////////////////////////////////////////////////////////////////////////////////////////////////////

    {if logged_in}
        var chat_nickname 	= "{screen_name}";
        var photo_url		= "{site_url}/images/member_photos/50x50/photo_<?php echo $member_id_reference; ?>.jpg";
    {if:else}
        var chat_nickname 	= "Worshiper <?php echo $member_id_reference; ?>";
        var photo_url		= "{site_url}/images/avatar.png";
    {/if}


    var chat_tabs_open = 0; 	// Number of chat tabs currently open
    var chat_slider_index = 0;	// Current index/location of slider
    var chat_tabs_max = 12; 		// Max number of chat tabs viewable at once
    var chat_tab_bar_width = 0; // Width of tab bar
    var current_chat_uid = "";	// Current opened chat UID

    Handlebars.registerHelper('handlebars_if', function(conditional, options) {
        if (typeof conditional === 'function' && toString.call(conditional) === '[object Function]') { conditional = conditional.call(this); }

        if ((!options.hash.includeZero && !conditional)) { return options.inverse(this); }
        else { return options.fn(this); }
    });

    Handlebars.registerHelper('ifCond', function(v1, v2, options) {
        if(v1 === v2) { return options.fn(this); }
        else { return options.inverse(this); }
    });

    Handlebars.registerHelper('dateFormat', function(context, options) {
        return moment(this.date).format("h:mma");
    });

    $(document).ready(function() {
        {if logged_in}
            {exp:member:custom_profile_data}
                {if manual_city_state == "Yes"}
                    $("#profile-location").html(client_location);
                {/if}
            {/exp:member:custom_profile_data}

            $('#filter-search').val("");
        {/if}

        {if group_id == "1" || group_id == "19" || group_id == "13"}
            AdminServiceLiveCheck();
        {/if}

        {if service_live != "true"}
            CheckServiceLive();
        {/if}

        // Check on resize and check browser width to not apply on mobile
        if ($(window).width() > 767) { // apply on initial load
            checkWorshipContain();
        }
        $(window).resize(function() { // apply when browser resizes
            if ($(window).width() > 767) {
                checkWorshipContain();
            }
        });

        // Giving Form
        $("#giving-form").submit(function(event) {
            event.preventDefault();

            var values = {};
            var data = $(this).serializeArray();
            $.each(data, function(i, field){
                values[field.name] = field.value;
            });

            //Value Retrieval Function
            var getValue = function (valueName) {
                return values[valueName];
            };

            //Retrieve the Values
            var amount = getValue("amount");
            var fund = getValue("fund");

            if(fund == 0) {
                window.open('https://pushpay.com/g/northlandchurch?a=' + amount, '_blank');
            } else if (fund == 1) {
                window.open('https://pushpay.com/g/northlandmissions?r=no&a=' + amount, '_blank');
            } else if (fund == 2) {
                window.open('https://pushpay.com/g/northlandmissions?r=no&f%5B0%5D=Support%20Disaster%20Relief&a=' + amount, '_blank');
            }
        });

        // Chat
        $('#groupchat_field').val("");

        $("#group_chat_form").submit(function(e) {
            e.preventDefault();

            var message = $("#groupchat_field").val().trim();
            if (message.length) 
            {
                socket.emit('send group message', message);

                $("#groupchat_field").val("");
            }
        });

        $('#filter-search').keyup(function() {
            var searchname = $('#filter-search').val();
            findPeople(searchname);
        });

        $('#guide-tab').click(function() {
            LoadIssuu();
        });


        $(document).on('click', '.single-chat-header', function() {
            ToggleChatWindow($(this).attr('id').replace("chat-header",""));
        });

        $(document).on('click', '.chat-tab', function() {
            ToggleChatWindow($(this).attr('id').substring(3));
        });

        // Custom click handler for Bootstrap dropdowns
        $('.dropdown-menu').on('click', function(event){
            var events = $._data(document, 'events') || {};
            events = events.click || [];
            for(var i = 0; i < events.length; i++) {
                if(events[i].selector) {
                    //Check if the clicked element matches the event selector
                    if($(event.target).is(events[i].selector)) {
                        events[i].handler.call(event.target, event);
                    }

                    // Check if any of the clicked element parents matches the 
                    // delegated event selector (Emulating propagation)
                    $(event.target).parents(events[i].selector).each(function(){
                        events[i].handler.call(this, event);
                    });
                }
            }
            event.stopPropagation(); //Always stop propagation
        });

        $groupchats = $("#chat-box-list");
        $privatechats = $("#chat-slider-ul");
        $users_count = $("#current-viewers");

        $ministerroster = $("#minister");
        $hostroster = $("#host");
        $techsupportroster = $("#tech-support");
        $peopleroster = $("#people");

        groupmessage_template = Handlebars.compile($("#groupmessage_html").html());
        rosteruser_template = Handlebars.compile($("#rosteruser_html").html());
        privatecontainer_template = Handlebars.compile($("#privatecontainer_html").html());
        privatemessage_template = Handlebars.compile($("#privatemessage_html").html());

        InitializeEventHandlers();

        initiate_geolocation();


        $('#worship-contain').scroll(function() {
            $('#onlineworship-video').css('top', $(this).scrollTop());
        });
    });

    // Height of containers on page to make same size on desktop
    function checkWorshipContain() {
        var min_height = -1;
        var nav_tab_height = $(".nav-tabs").height()
        $('.tab-content').css('height', 'auto');
        $(".worship-contain--col").each(function() {
            $('.worship-contain').css('height', 'auto');
            if ($(this).height() < min_height || min_height == -1) {
                min_height = $(this).height();
            }
            $('.worship-contain').css('min-height', min_height);
        })

        $(".tab-content").height(min_height - nav_tab_height);
    }


    //////////////////////////////////////////////////////////////////////////////////////
    // 	Event handlers for Modals
    //////////////////////////////////////////////////////////////////////////////////////
    $(document).ready(function() {

    /*
        $('.modal-content').resizable({
            minHeight: 360,
            minWidth: 640
        });
    */
        // Make modal draggable on modal-header section
        $('.modal-dialog').draggable({
            handle: ".modal-header"
        });

        $('#btn1').click(function() {
            var modalDiv = $('#worshipModal');
            modalDiv.modal({backdrop: false, show: true});
        });

        // Handler for 'Back to Selection' button
        $('.welcome-button').click(function(e) {
            $('.modal').modal('hide');
            $('#welcomeModal').modal('show');
        });


        // Handler for 'Click to Login with Northland' button
        $('.login-button').click(function(e) {
            $('.modal').modal('hide');
            $('#loginModal').modal('show');
        });

        // Handler for 'Join Worship without Login' button
        $(".login-button-anonymous").click(function(e) {
            $('.modal').modal('hide');
            $('#welcomeNotLoggedInModal').modal('show');
        });


        $(".clickRegisterLink").on('click', function(event) {
            $('.modal').modal('hide');
            $("#registerModal").modal('show');

            // Pass email address to Register modal
            var email = $("#loginModal #username").val();
            $("#registerModal #username").val(email);

            return false;
        });

        $(".clickLoginLink").on('click', function(event) {
            $('.modal').modal('hide');
            $("#loginModal").modal('show');

            // Pass email address to Login modal
            var email = $("#registerModal #regusername").val();
            $("#loginModal #regusername").val(email);

            return false;
        });

        // Trigger proper method based on the form clicked
        $("form").submit(function(event) {
            clearAllAlert();

            switch(event.target.id) {
                case "Login":
                    event.preventDefault();
                    processLogin();
                    break;
                case "Register":
                    event.preventDefault();
                    processRegister();
                    break;
                default:
                    break;
            }

        });

        // Required validation check when text field entered
        $("input[type='text'].required").keyup(function() {
            // Get the value of the text input and ID 
            var value		= $(this).val().trim();
            var valueid 	= $(this).attr('id');

            if (value == '')
                $("#required_"+valueid).show();
            else 
                $("#required_"+valueid).hide();
        }).keydown(function(event) {
            if ( event.which == 13 ) {
                event.preventDefault();
            }
        });

        // Password validation check when text field entered
        $("input[type='password'].required-password").keyup(function() {
            // Get the value of the text input and ID 
            var value		= $(this).val();
            var valueid 	= $(this).attr('id');

            // Check if the password is sufficiently long (min 6 chars)
            if (value.length < 6) {
                $("#errorlength_"+valueid).show();
                return false;
            } else {
                $("#errorlength_"+valueid).hide();
            }

            // At least one number, one lowercase and one uppercase letter 
            // At least six characters 
            var re = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/; 
            if (!re.test(value)) {
                $("#errorcomb_"+valueid).show();
                return false;
            } else {
                $("#errorcomb_"+valueid).hide();
            }
        }).keydown(function(event) {
            if ( event.which == 13 ) {
                event.preventDefault();
            }
        });

        // Password for Conformation validation check when text field entered
        $("input[type='password'].required-confirmpw").keyup(function() {
            // Get the value of the text input and ID 
            var value		= $(this).val();
            var valueid 	= $(this).attr('id');
            var password	= $("#registerModal #regpassword").val();

            // Check password and confirmation are the same
            if (password != value) {
                $("#error_"+valueid).show();
            } else {
                $("#error_"+valueid).hide();
            }
        }).keydown(function(event) {
            if ( event.which == 13 ) {
                event.preventDefault();
            }
        });

        // Email checking when email input loses focus
        $('#loginModal #username').blur(function() {
            clearAllAlert();

            // Retrieve Username from Login modal
            var email = $("#loginModal #username").val().trim();

            if (!validateEmail(email))
            {
                $("#loginModal #invalid_username").show();
                return false;
            }

            // Send a request to check if email exists
            $.ajax({
                url: '/scripts/check_email_unique_v2.php',
                data: "email=" + email,
                dataType: 'json',
                success: parseLoginEmailCheck,
                error: function() {
                    $("#login_error").html("Internal system error in email duplicate checking. Please contact Administrator with this message.");
                    $("#login_error").show();
                }
            });
        });

        // Email checking when email input loses focus
        $('#registerModal #regusername').blur(function() {
            clearAllAlert();

            // Retrieve Username from Login modal
            var email = $("#registerModal #regusername").val().trim();

            if (!validateEmail(email))
            {
                $("#registerModal #invalid_username").show();
                return false;
            }

            // Send a request to check if email exists
            $.ajax({
                url: '/scripts/check_email_unique_v2.php',
                data: "email=" + email,
                dataType: 'json',
                success: parseRegisterEmailCheck,
                error: function() {
                    $("#register_error").html("Internal system error in email duplicate checking. Please contact Administrator with this message.");
                    $("#register_error").show();
                }
            });
        });

        $("#reset_pw").click(function()
        {
            var email = $("#loginModal #username").val().trim();

            $.ajax({
                url: '/scripts/password_reset.php?email=' + email,
                success: function(data) {
                    $("#login_error").html(data);
                    $("#login_error").show();
                }
            });

        });
    });
    //////////////////////////////////////////////////////////////////////////////////////
    // 	End of Event handlers for Modals
    //////////////////////////////////////////////////////////////////////////////////////



    var issuu_loaded = 0;
    function LoadIssuu() 
    {
        if (issuu_loaded == 0) 
        {
            $('#guide').load("/Webflow/worshipguide.txt");

            issuu_loaded = 1;
        }
    }

    function InitializeEventHandlers()
    {
        var active_worshipers = getCookie('active_worshipers');
        {if logged_in}
            // If cookie is still available, use it
            if(active_worshipers) {
                ChatConnect();
                UpdateGroupSize(active_worshipers);
                UpdateMyUserInfo();
                setTimeout("UpdateStats(1, active_worshipers)", 120000); // Add to stats after 120 seconds
            } else {
                $('#welcomeLoggedInModal').modal('show');
            }

            $('#update_number_worshipers').click(function(e)
            {
                ChatConnect();

                var temp_groupsize = $('#num_worshipers').val();

                if ($.isNumeric(temp_groupsize) && temp_groupsize > 0 && temp_groupsize < 100) {
                    logged_in_groupsize = temp_groupsize;
                    UpdateGroupSize(logged_in_groupsize);
                    UpdateMyUserInfo();
                    setCookie('active_worshipers',logged_in_groupsize,'5400'); // Set cookie so users don't have to keep doing this -- expires in 1.5 hrs
                    setTimeout("UpdateStats(1, logged_in_groupsize)", 120000); // Add to stats after 120 seconds
                }
                else
                {
                    UpdateGroupSize(logged_in_groupsize);
                    UpdateMyUserInfo();
                    setCookie('active_worshipers',logged_in_groupsize,'5400');
                    setTimeout("UpdateStats(1, 1)", 120000); // Add to stats after 120 seconds
                }

                $('#welcomeLoggedInModal').modal('hide');
                return false;
            });
        {if:else}
            $('#welcomeModal').modal('show');

            $('#update_number_worshipers1').click(function(e)
            {
                var temp_groupsize = $('#num_worshipers1').val();

                if ($.trim($("#name_worshipers").val()).length >= 2)
                {
                    $("#anonymous_name").text($.trim($("#name_worshipers").val()));
                    $("#anonymous_name").profanityFilter({
                        externalSwears: '/_js/swearWords.json'
                    });

                    chat_nickname = $.trim($("#anonymous_name").text());

                    ChatConnect();

                    if ($.isNumeric(temp_groupsize) && temp_groupsize > 0 && temp_groupsize < 100) {
                        logged_in_groupsize = temp_groupsize;
                        UpdateGroupSize(logged_in_groupsize);
                        UpdateMyUserInfo();
                        setCookie('active_worshipers',logged_in_groupsize,'5400');
                        setTimeout("UpdateStats(1, logged_in_groupsize)", 120000); // Add to stats after 120 seconds
                    }
                    else
                    {
                        UpdateGroupSize(logged_in_groupsize);
                        UpdateMyUserInfo();
                        setCookie('active_worshipers',logged_in_groupsize,'5400');
                        setTimeout("UpdateStats(1, 1)", 120000); // Add to stats after 120 seconds
                    }

                    $('#welcomeNotLoggedInModal').modal('hide');
                }
                else
                {
                    if ($("#alert_enter_name").is(":visible")) {
                        $("#alert_enter_name").fadeOut(function() {
                            $("#alert_enter_name").fadeIn();
                        });
                    }
                    else {
                        $("#alert_enter_name").slideDown();
                    }
                }

                return false;
            });

            $("#name_worshipers").keyup(function(event)
            {
                var w_name = $.trim($("#name_worshipers").val());
                var regexp = /[^a-z A-Z]/g;

                if (w_name.length < 2) {
                    $("#alert_enter_name").slideDown();
                }
                else {
                    $("#alert_enter_name").slideUp();
                }

                if (w_name.match(regexp))
                {
                    $("#alert_alphabet").slideDown();
                }
                else
                {
                    $("#alert_alphabet").slideUp();
                }
            });
        {/if}

        document.onkeydown = function(e) {
            switch (e.keyCode) {
                case 37:
                    // console.log("left");
                    ModifyChatTabIndex(-1);
                    break;
                case 38:
                    // console.log("up");
                    break;
                case 39:
                    // console.log("right");
                    ModifyChatTabIndex(1);
                    break;
                case 40:
                    // console.log("down");
                    break;
                case 27:
                    // console.log("esc");
                    HideChatWindows();
                    break;
            }
        };

        $('#chat-right').click(function() { ModifyChatTabIndex(1); });
        $('#chat-left').click(function() { ModifyChatTabIndex(-1); });


        $(window).bind('beforeunload', function() {
            UpdateStats(0, 0);
        });


        $("#share_form").submit(function() {
            if ($('#shareform_from_name').val().trim() == "")
            {
                alert("Please enter your name.");
                return false;
            }
            if ($('#shareform_from_email').val().trim() == "")
            {
                alert("Please enter your email.");
                return false;
            }
            if ($('#shareform_to_name').val().trim() == "")
            {
                alert("Please enter recipient's name.");
                return false;
            }
            if ($('#shareform_to_email').val().trim() == "")
            {
                alert("Please enter recipient's email.");
                return false;
            }

            $.post("/scripts/share-worship-email.php", { from_name: $('#shareform_from_name').val(), from_email: $('#shareform_from_email').val(), to_name: $('#shareform_to_name').val(), to_email: $('#shareform_to_email').val(), message: $('#shareform_message').val() }, function(data) {
                if (data == 1) {
                    alert("Thanks! Your email was successfully sent."); 
                } else {
                    alert("There was an error sending your email. Please contact an admin.<br>(Error: " + data + ")"); 
                }
            });

            return false;
        });


    }


    //////////////////////////////////////////////////////////////////////////////////////
    // 	Event handlers for Chat Node Server
    //////////////////////////////////////////////////////////////////////////////////////
    function ChatConnect() 
    {
        socket = io.connect('https://newdevchat.northlandchurch.net:3000', {
            'reconnect': true,
            'reconnectionDelay': 2000,
            'max reconnection attempts': 10000,
            'forceNew': true
        });

        socket.on('connect', function() {
            ChatLogin();

            if (first_connection) 
            {
                socket.emit("get recent messages");
                first_connection = false;
            }
        });

        socket.on('duplicate connection', function() {
            duplicate_connection = true;
        });

        socket.on('disconnect', function() {
            $("#disconnected_label").fadeIn();
            $('#chatroster').addClass('chatrosterdisconnected');
            $('.youdisconnected').remove();
            $('.pchatmsgbox').attr("disabled","disabled").css("background-color","#BBB");
            $('.chatbox').append('<div class="pmsg_notification youdisconnected">You have been disconnected.</div> <div id="clear"></div>');

            if (duplicate_connection) {
                $("#chat-disconnected").html('Disconnected from chat...<br>Another browser connected with your account').show();
            }
            else {
                $("#chat-disconnected").html('Disconnected from chat...<br>Attempting to reconnect').show();
            }
        });

        socket.on('chat users', function(data) {
            ClearChatUsers();

            if (data) 
            {
                for (i = 0; i < data.length; i++) 
                {
                    AddChatUser(data[i]);
                }
            }

        StartChatUsersUpdateCycle();
        });

        socket.on('new chat user', function(data) {
            AddChatUser(data);

            $(".private_link_" + data.chatid).show();
        });

        socket.on('remove chat user', function(data) {
            RemoveChatUser(data);
        });

        socket.on('group message', function(data) {
            data.user_online = true;

            if (data.message == "command: open card tab")
            {
                $('.tabs').tabs({active: 2 });
            }
            else
            {
                $groupchats.prepend(groupmessage_template(data));
            }
        });

        socket.on('remove group message', function(data) {
        $("#groupmessage_" + data).remove();
        });

        socket.on('clear group chat', function() {
        $("#chat-box-list").html("");
        });

        socket.on('recent messages', function(data) {
            for(i = 0; i < data.length; i++) {
                if (data[i].message != "command: open card tab") 
                {
                    $groupchats.append(groupmessage_template(data[i]));
                }
            }
        });

        socket.on('private message', function(data) {
            if(data.chatid && data.nickname) 
            {
                if ($("#privatecontainer_" + data.chatid).length == 0) 
                {
                    StartPrivateChat(data.chatid, data.nickname);
                }
                else 
                {
                    if (!$("#div" + data.chatid).is(":visible")) 
                    {
                        $("#tab" + data.chatid).addClass('new-message');

                        var alert_html = '<div class="alert alert-info alert-dismissible fade show alert_' + data.chatid + '" role="alert">' 
                                    + 'Message received from <a class="alert-link" style="cursor: pointer;" onclick="ToggleChatWindow(\'' + data.chatid + '\'); $(\'.alert_' + data.chatid + '\').alert(\'close\');">' + data.nickname + '</a>'
                                    + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                                    + '</div>';
                        $("#alert-container").prepend(alert_html);
                    }
                }

                //if (data.keyCode == 27) {
                //    ClosePrivateChat(data.chatid);
                //}

                if (data.mine && $("#privatemessages_" + data.chatid + " > div:last").hasClass("pmsg_me_bg")) {
                    $("#privatemessages_" + data.chatid + " > .pmsg > .pmsg_body_container:last").append("<p class='pmsg_body'>" + data.message + "</p>");
                }
                else if (data.mine == null && $("#privatemessages_" + data.chatid + " > div:last").hasClass("pmsg_you_bg")) {
                    $("#privatemessages_" + data.chatid + " > .pmsg > .pmsg_body_container:last").append("<p class='pmsg_body'>" + data.message + "</p>");
                }
                else {
                $("#privatemessages_" + data.chatid).append(privatemessage_template(data));
                }

                var elem = document.getElementById("privatemessages_" + data.chatid);
                elem.scrollTop = elem.scrollHeight;
            }
        });

        socket.on('updated user', function(data) {
            if (data.chatid) {
                if (data.latitude && data.longitude) {
                    usersArray[data.chatid].SetLatLng(data.latitude, data.longitude);
                    //RemoveMarker(data.chatid);
                    AddMarker(data.chatid, data.latitude, data.longitude);
                }

                if (data.location) {
                    usersArray[data.chatid].location = data.location;
                    $("#address" + data.chatid).text(data.location);
                }

                if (data.groupsize) {
                    usersArray[data.chatid].groupsize = data.groupsize;
                }

                if (data.nickname) {
                    usersArray[data.chatid].fullname = data.nickname;
                    $("#fullname_" + data.chatid).text(data.nickname);
                    $("#personchat" + data.chatid).attr("href", "javascript:StartPrivateChat('" + data.chatid + "', '" + data.nickname + "');");
                }
            }
        });
    }
    //////////////////////////////////////////////////////////////////////////////////////
    // 	End of Event handlers for Chat Node Server
    //////////////////////////////////////////////////////////////////////////////////////



    var myGroupSize = 1;
    function UpdateGroupSize(num) 
    {
        myGroupSize = num;
        if (socket && socket.connected) 
        {
            socket.emit('update user', { groupsize: logged_in_groupsize, nickname: chat_nickname});
        }
    }


    function UpdateStats(action_login, groupsize) 
    {
        {if logged_in}
            // Store that user logged in
            if (action_login == 1) {
                $.post("/scripts/update-stats.php", { member_id: {member_id}, anon: '0', action_login: '1', group_size: groupsize, lat: client_latitude, lng: client_longitude, location: client_location});
            }
            // Store that user logged out
            else if (action_login == 0) {
                $.post("/scripts/update-stats.php", { member_id: {member_id}, anon: '0', action_login: '0', group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location});
            }
            else {
                $.post("/scripts/update-stats.php", { member_id: {member_id}, anon: '0', action_login: action_login, group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location}, function() { location.reload(); });
            }
        {if:else}
            // Store that user logged in
            if (action_login == 1) {
                $.post("/scripts/update-stats.php", { member_id: '<?php echo $member_id_reference; ?>', anon: '1', action_login: '1', group_size: groupsize, lat: client_latitude, lng: client_longitude, location: client_location});
            }
            // Store that user logged out
            else if (action_login == 0) {
                $.post("/scripts/update-stats.php", { member_id: '<?php echo $member_id_reference; ?>', anon: '1', action_login: '0', group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location});
            }
            else {
                $.post("/scripts/update-stats.php", { member_id: '<?php echo $member_id_reference; ?>', anon: '1', action_login: action_login, group_size: '0', lat: client_latitude, lng: client_longitude, location: client_location}, function() { location.reload(); });
            }
        {/if}
    }


    {if logged_in}
        function ChatLogin() 
        {
            socket.emit('connect user', { nickname: chat_nickname, 
                                        chatid: '<?php echo $member_id_reference; ?>', 
                                        usertype: '{exp:member:custom_profile_data}{if online_worship_role}{online_worship_role}{if:else}Worshiper{/if}{/exp:member:custom_profile_data}', 
                                        email: '{if email}{email}{/if}', 
                                        latitude: client_latitude, 
                                        longitude: client_longitude, 
                                        location: client_location, 
                                        groupsize: logged_in_groupsize, 
                                        photourl: photo_url
            });

            $("#chat-disconnected").hide();
            $('.pchatmsgbox').removeAttr("disabled").css("background-color","#FFF");
            $('#chatroster').removeClass('chatrosterdisconnected');
            $('.youdisconnected').remove();
        }
    {if:else}
        function ChatLogin() 
        {
            socket.emit('connect user', { nickname: chat_nickname , chatid: 'anon_<?php echo $member_id_reference; ?>', latitude: client_latitude, longitude: client_longitude, location: client_location, groupsize: logged_in_groupsize, photourl: photo_url });

            $("#chat-disconnected").hide();
            $('.pchatmsgbox').removeAttr("disabled").css("background-color","#FFF");
            $('#chatroster').removeClass('chatrosterdisconnected');
            $('.youdisconnected').remove();
        }
    {/if}

    function SendPrivateMessage(id, message)
    {
        if (id && message) {
            socket.emit('send private message', { receiverid: id, msg: message });
        }
    }


    // Special Functions for Administator
    {if group_id == "1" || group_id == "19" || group_id == "13"}
        function RemoveGroupMessage(messageid)
        {
            var confirmation = confirm("Are you sure you want to delete this chat message?");
            if (confirmation == true)
            {
                socket.emit('remove group message s3cretc0de', messageid);
            }
        }

        function ClearGroupChat()
        {
            var confirmation = confirm("Are you sure you want to clear chat?");
            if (confirmation == true)
            {
                socket.emit('clear group chat s3cretc0de');
            }
        }
    {/if}

    function ClearChatUsers()
    {
        markersArray = {};
        usersArray = {};

        UpdateMyUserInfo();	// Add my location/chat info back to the list

        $ministerroster.html("");
        $hostroster.html("");
        $techsupportroster.html("");
        $peopleroster.html("");

    }

    function UpdateMyUserInfo() 
    {
        AddUser(<?php echo $member_id_reference; ?>, client_latitude, client_longitude, client_location, "{screen_name}", logged_in_groupsize, true, photo_url);
        AddMarker(<?php echo $member_id_reference; ?>, client_latitude, client_longitude);
    }

    // User info container to store latitude, longitude, and UID. Has functions for returning Google Marker and LatLng objects
    function UserInfo(uid) 
    {
        this.uid = uid;
        this.latlng = new google.maps.LatLng();
        this.location = "";
        this.fullname = "";
        this.role = null;
        this.avatarurl 	= "";
        this.photourl 	= "";
        this.marker 	= new google.maps.Marker();
        this.groupsize 	= 1;

        this.SetLatLng = function(lat, lng) {
            this.latlng = new google.maps.LatLng(lat,lng);
            this.marker = new google.maps.Marker({position: this.latlng, title: uid.toString()});
        }
        this.SetLocation = function (loc) { this.location = loc; }
        this.SetFullName = function(name) { if (name) { this.fullname = name; } }
        this.SetGroupSize = function(size) { this.groupsize = size; }
        this.SetSignedIn = function() { this.signedin = true; }
        this.GetUID = function() { return this.uid; }
        this.GetMarker = function() { return this.marker; }
        this.GetLatLng = function() { return this.latlng; }
        this.GetLocation = function() { return this.location; }
        this.GetFullName = function() {
            if (this.fullname) { return this.fullname; }
            else { return ""; }
        }
        this.GetGroupSize = function() { return this.groupsize; }
        //this.toString = function() { return "UID: " + this.uid + ", Name: " + this.fullname + ", LatLng: " + this.latlng + ", Location: " + this.location; }

        this.SetPhotoUrl = function (url) { this.photourl = url; }
        this.GetPhotoUrl = function() { return this.photourl; }
    }

    function AddChatUser(data) 
    {
        if (data.usertype == "minister") { $ministerroster.prepend(rosteruser_template(data)); }
        else if (data.usertype == "host") { $hostroster.prepend(rosteruser_template(data)); }
        else if (data.usertype == "support") { $techsupportroster.prepend(rosteruser_template(data)); }
        else {
            $peopleroster.prepend($(rosteruser_template(data)).hide().fadeIn(3000));
        }

        AddUser(data.chatid, data.lat, data.lon, data.loc, data.name, data.groupsize, data.usertype, data.photourl);
        AddMarker(data.chatid, data.lat, data.lon);

        // Add private chat onto the slider bar so that worship admin group can chat easily
        {if group_id == "1" || group_id == "19" || group_id == "13"} // Admins
            // for existing user
            if (document.getElementById("privatemessages_" + data.chatid)) 
            {
                $("#privatemessages_" + data.chatid + " .user_disconnected").remove();
                $("#private_chatfield_" + data.chatid).removeAttr("disabled").css("background-color","#FFF");
                $("#tab" + data.chatid).removeClass('tab-loggedoff');
            }
            // for a new chat user
            else
            {
                var tab_nickname = "";
                var chatid = data.chatid;

                // Fix name of chat user for title
                if (data.name.length > 10) {
                    tab_nickname = data.name.substr(0,10) + "...";
                } else {
                    tab_nickname = data.name;
                }

                // Add the chat to the tabs
                $privatechats.append(privatecontainer_template({chatid : chatid, tabnickname: tab_nickname, nickname: data.name, local: data.loc, img: data.photourl, is_img: true, is_local: true}));
    			// $("#private_chatfield_" + chatid).autosize();
                autosize($("private_chatfield_" + chatid));

                $("#private_chatfield_" + chatid).keypress(function(e) {
                    if (e.keyCode == 13) {
                        e.preventDefault();
                        SendPrivateMessage(chatid, $("#private_chatfield_" + chatid).val());
                        $("#private_chatfield_" + chatid).val("");
                        $("#private_chatfield_" + chatid).resize();
                    }
                });

                // Reposition tabs if it's outside the max in the tab slider
                var chatid_tab_index = $('#privatecontainer_' + chatid).index('.single-chat');

                if (chatid_tab_index > chat_tabs_max + chat_slider_index - 1) {
                    SetChatTabIndex(chatid_tab_index - chat_tabs_max + 1);
                }
                UpdateChatTabs();

                // $("#private_chatfield_" + chatid).val(data.name);

                $("#privatecontainer_" + chatid).removeClass('selected');
                $("#tab" + chatid).removeClass('tab-selected');
                $("#div" + chatid).hide();
            }
        {if:else}		// General
            // Change the color priavate chat element when someone joins worship again
            if (document.getElementById("privatemessages_" + data.chatid)) 
            {
                $("#privatemessages_" + data.chatid + " .user_disconnected").remove();
                $("#private_chatfield_" + data.chatid).removeAttr("disabled");
                $("#tab" + data.chatid).removeClass('tab-loggedoff');
            }
        {/if}
    }

    function AddUser(chatid, lat, lng, loc, fullname, groupsize, role, photourl) 
    {
        var userInfo = new UserInfo(chatid);
        userInfo.SetLatLng(lat, lng);
        userInfo.location = loc;
        userInfo.fullname = fullname;
        userInfo.groupsize = groupsize;
        userInfo.role = role;
        userInfo.photourl = photourl;

        usersArray[chatid] = userInfo;
    }

    function RemoveChatUser(chatid) 
    {
        $("#worshiper" + chatid).remove();

    if (document.getElementById("privatemessages_" + chatid)) 
    {
            $("#privatemessages_" + chatid).append('<div class="pmsg_notification user_disconnected">This person has logged off.</div><div class="clear"></div>');
            $("#private_chatfield_" + chatid).attr("disabled","disabled").css("background-color","#BBB");
            $("#tab" + chatid).addClass('tab-loggedoff');
    }

    $(".private_link_" + chatid).hide();

    RemoveUser(chatid);
    RemoveMarker(chatid);
    }

    function RemoveUser(chatid) 
    {
        delete usersArray[chatid];
    }

    function StartPrivateChat(chatid, nickname) 
    {
        if ($("#privatecontainer_" + chatid).length == 0) 
        {
            HideChatWindows();
            var tab_nickname = "";

            if (nickname.indexOf("Worshiper ") != -1) {
                tab_nickname = nickname.replace("Worshiper ", "");
            }
            else if (nickname.length > 10) { tab_nickname = nickname.substr(0,10) + "...";	}
            else { tab_nickname = nickname; }

            $privatechats.append(privatecontainer_template({chatid : chatid, tabnickname: tab_nickname, nickname: nickname, is_img: false, is_local: false}));
    //		$("#private_chatfield_" + chatid).autosize();
            autosize($("private_chatfield_" + chatid));

            $("#private_chatfield_" + chatid).keypress(function(e) {
                if (e.keyCode == 13) {
                    e.preventDefault();
                    SendPrivateMessage(chatid, $("#private_chatfield_" + chatid).val());
                    $("#private_chatfield_" + chatid).val("");
                    $("#private_chatfield_" + chatid).resize();
                }
            });

    //		 $("#privatemessages_" +  chatid).slimScroll({ height: '100%', size: '5px', start: 'bottom', railVisible: true, railOpacity: 0.5 });

            // Reposition tabs if it's outside the max in the tab slider
            var chatid_tab_index = $('#privatecontainer_' + chatid).index('.single-chat');

            if (chatid_tab_index > chat_tabs_max + chat_slider_index - 1) 
            {
                SetChatTabIndex(chatid_tab_index - chat_tabs_max + 1);
            }
        }
        else 
        {
            ToggleChatWindow(chatid);
        }

        $("#private_chatfield_" + chatid).focus();

        UpdateChatTabs();
    }

    function ClosePrivateChat(chatid) 
    {
        $("#privatecontainer_" + chatid).remove();
        if(chat_slider_index > 0) { ModifyChatTabIndex(-1); }
        UpdateChatTabs();
    }

    function HideChatWindows() 
    {
        $('.single-chat-window').hide();
        $('.chat-tab').removeClass("tab-selected");

        // Hide main private chat list
        $(".private-chat").removeClass('show');
        $(".private-chat--list").removeClass('show');
    }


    function ModifyChatTabIndex(val) 
    {
        chat_slider_index += val;
        SetChatTabIndex(chat_slider_index);
    }

    function SetChatTabIndex(val) 
    {
        chat_slider_index = val;
        UpdateChatTabs();
    }


    function ToggleChatWindow(chatid) 
    {
        var $div = $("#div" + chatid);
        var $tab = $("#tab" + chatid);

        if ($div.is(":visible")) {
            $div.hide();
            $tab.removeClass('tab-selected');
        }
        else 
        {
            $(".single-chat.selected > .single-chat-window").hide();
            $(".single-chat.selected > .chat-tab").removeClass("tab-selected");
            $(".single-chat.selected").removeClass("selected");

            $div.show();
            $("#privatecontainer_" + chatid).addClass('selected');
            $("#private_chatfield_" + chatid).focus();
            $tab.removeClass('new-message').addClass('tab-selected');

            // Reposition tabs if it's outside the max in the tab slider
            var chatid_tab_index = $('#privatecontainer_' + chatid).index('.single-chat');

            if (chatid_tab_index > chat_tabs_max + chat_slider_index - 1) {
                SetChatTabIndex(chatid_tab_index - chat_tabs_max + 1);
            }
            else if (chatid_tab_index < chat_slider_index) {
                SetChatTabIndex(chatid_tab_index);
            }

            /*var uid_tab_index; // Index # of chat tab in list

            // Are there more tabs than allowed to be displayed at once?
            if (chat_tabs_open > chat_tabs_max) {
                uid_tab_index = $('#privatecontainer_' + uid).index('.single-chat');

                if (uid_tab_index != -1) {
                    // Tab is off the screen to the left
                    if (uid_tab_index < chat_slider_index) {
                        SetChatTabIndex(uid_tab_index);
                    }
                    // Tab is off the screen to the right
                    else if (uid_tab_index > chat_slider_index + chat_tabs_max - 1) {
                        var set_chat_tab_index = chat_slider_index + chat_tabs_max - 1;
                        console.log("Set Chat tab index: " + set_chat_tab_index);
                        if(chat_tabs_open - set_chat_tab_index < chat_tabs_max) {
                        SetChatTabIndex(chat_tabs_open - chat_tabs_max); } // Don't let gaps appear after chat tabs if near the end of tabs
                        else { SetChatTabIndex(set_chat_tab_index); }
                    }
                }
            }*/

            $("#privatemessages_" + chatid).scrollTop($("#privatemessages_" + chatid)[0].scrollHeight);
        }
    }


    function UpdateChatTabs() 
    {
        chat_tabs_open = $('.single-chat').length;

        if (chat_tabs_open > chat_tabs_max) 
        {
            chat_tab_bar_width = chat_tabs_max * 100; // 102 pixels wide per chat tab

            if(chat_slider_index >= 0 && (chat_tabs_max + chat_slider_index) < chat_tabs_open) { $('#chat-right').show(); }
            else { $('#chat-right').hide(); }

            if(chat_slider_index <= 0) { $('#chat-left').hide(); }
            else { $('#chat-left').show();	}
        }
        else
        {
            chat_tab_bar_width = chat_tabs_open * 100; // 102 pixels wide per chat tab
            $('#chat-left').hide();
            $('#chat-right').hide();
        }

        // Hide some chat tabs
        $('.single-chat').each(function(index)
        {
            if (index < chat_slider_index || index > chat_slider_index + chat_tabs_max - 1) { $('#' + this.id).hide(); }
            else { $('#' + this.id).show();	}
        });

        // Repositions chat windows to be above chat tab
        $('.single-chat-window').each(function()
        {
            var temp_divid = this.id.substring(3);
            $('#div' + temp_divid).css({'bottom': '56px', 'left': $('#privatecontainer_' + temp_divid).position().left});
        });

    }

    var ChatUserUpdateStartedFlag = false;
    function StartChatUsersUpdateCycle()
    {
        if (!ChatUserUpdateStartedFlag)
        {
            ChatUsersUpdateCycle();
        }
    }

    function ChatUsersUpdateCycle()
    {
    //	UpdateChatList();
        UpdateChatCount();
        setTimeout("ChatUsersUpdateCycle()", 10000);
    }

    function UpdateChatCount() {
        var worshipers = 0;
        var sites = 0;

        for (var key in usersArray)
        {
    /*
            if (!isNaN(usersArray[key].groupsize)) { worshipers += parseInt(usersArray[key].groupsize);}
            else { worshipers++; }
    */
            if (!isNaN(usersArray[key].groupsize))
            {
                var tmp_groupsize = parseInt(usersArray[key].groupsize);
                if (!isNaN(tmp_groupsize)) { worshipers += tmp_groupsize; }
                else { worshipers++; }
            }
            else { worshipers++; }

            sites++;
        }

        var n_viewers = worshipers + " worshipers at " + sites + " sites";

        if ("{service_live}" == "true")
        {
            $users_count.html("<strong>LIVE:</strong> " + n_viewers);
        }
        else
        {
            $users_count.html(n_viewers);
        }
    }

    function findPeople(name)
    {
        if (name.length > 0) {
            $('.person').removeClass('person-found');

            $(".privatechat-roster--name").each(function() {
                if ($(this).text().toLowerCase().indexOf(name.toLowerCase()) != -1) {
                    $(this).closest(".person").addClass("person-found");
                }
            });

            list_toggle = 'findpeople';
            FilterChatList();
        }
        else {
            list_toggle = 'everyone';
            FilterChatList();
        }
    }

    function FilterChatList()
    {
        if (list_toggle == 'everyone') {
            $('#friends_hide').html("");
        }
        else if (list_toggle == 'findpeople') {
            $('#friends_hide').html("<style>.person { display: none !important; } .person-found{ display: block !important; }</style>");
        }
    }

    ////////////////////////////////////////////////////////////////////////
    // Event Handler when clicks 'Profile' button in the Worship Roster
    ////////////////////////////////////////////////////////////////////////
    function clickProfileExpand(el, profilename, userid) 
    {
        if (!$("."+profilename).is(':visible')) 
        {
            $("#prayer-text" + userid).empty();
            $("#prayer-text" + userid).append("Loading prayers");
            $("#profile-text" + userid).empty();
            $("#profile-text" + userid).append("Loading profile");

            $.ajax({
                url: '/_component/get-latestprayer/' + userid,
                success: function(data) {
                    $("#prayer-text" + userid).empty();
                    if (data != '') {
                        $("#prayer-text" + userid).append(data);
                    }
                    else {
                        $("#prayer-text" + userid).append('No recent prayer requests');
                    }
                }
            });

            $.ajax({
                url: '/_component/get-profilebio/' + userid,
                success: function(data) {
                    $("#profile-text" + userid).empty();
                    if (data != '') {
                        $("#profile-text" + userid).append(data);
                    }
                    else {
                        $("#profile-text" + userid).append('No user profile posted');
                    }
                }
            });

            $(".mini-profile").hide();
        }

        $("."+profilename).toggle("fast");
    }

    /////////////////////////////////////////////////////////////////////////////////////
    // 		Functions for Login/Register
    /////////////////////////////////////////////////////////////////////////////////////
    function processLogin()
    {
        // Retrieve Username from Login modal to check email validation
        var email = $("#loginModal #username").val().trim();
        if (!validateEmail(email))
        {
            $("#loginModal #invalid_username").show();
            return false;
        }

        // Send an request to check if email exists
        $.ajax({
            url: '/scripts/check_email_unique_v2.php',
            data: "email=" + email,
            dataType: 'json',
            success: parseLoginEmailCheckAndLogin,
            error: function() { 
                console.warning("Error in email duplicate checking...");
            }
        });

    }

    function processRegister()
    {
        var goodToGo 	= true;

        // Retrieve values in the form at Register modal to check validation
        var email 		= $("#registerModal #regusername").val().trim();
        var	firstname 	= $("#registerModal #firstname").val().trim();
        var	lastname 	= $("#registerModal #lastname").val().trim();
        var	password 	= $("#registerModal #regpassword").val();
        var	confirmpw 	= $("#registerModal #confirmpw").val();
        var	accept 		= $("#registerModal #accept_terms").val();

        //////////////////////////////////////////////////////////////////////
        // 					Validation Checking								//
        //////////////////////////////////////////////////////////////////////
        if (isEmpty(firstname))
        {
            $("#registerModal #required_firstname").show();
            goodToGo	= false;
        }
        if (isEmpty(lastname))
        {
            $("#registerModal #required_lastname").show();
            goodToGo	= false;
        }
        if (!isEmpty(password))
        {
            // Check if the password is sufficiently long (min 6 chars)
            if (password.length < 6) 
            {
                $("#registerModal #errorlength_password").show();
                goodToGo	= false;
            }

            // At least one number, one lowercase and one uppercase letter and At least six characters 
            var re = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/; 
            if (!re.test(password)) 
            {
                $("#registerModal #errorcomb_password").show();
                goodToGo	= false;
            }
        }
        if (password != confirmpw)
        {
            $("#registerModal #error_confirmpw").show();
            goodToGo	= false;
        }

        // Email validation check
        if (!validateEmail(email))
        {
            $("#registerModal #invalid_username").show();
            goodToGo	= false;
        }

        // Proceed when everything is okay!
        if (goodToGo)
        {
            // Send an request to check if email exists
            $.ajax({
                url: '/scripts/check_email_unique_v2.php',
                data: "email=" + email,
                dataType: 'json',
                success: parseRegisterEmailCheckAndRegister,
                error: function() {
                    console.warning("Error in email duplicate checking...");
                }
            });
        }
        else
        {
            console.warning("There are some items to fix to register youself!");
        }
    }

    function parseLoginEmailCheck(data)
    {
        var jsonObj = $.parseJSON(data);

        // No email found! STOP and show message!
        if(jsonObj.result == "unique")
        {
            $("#loginModal #noregister_username").show();
        } 
        else if (jsonObj.result == "duplicate")
        {
            // Only One email found, GOOD TO GO!
            if (jsonObj.count == 1)
            {
            }
            // Multiple emails found, STOP and show message!
            else if (jsonObj.count > 1)
            {
                $("#loginModal #multiple_username").show();
                console.warning(jsonObj.count + " email addresses exist.");
            }
            else
            {
                console.error("Undefined number of email accounts.");
                $("#login_error").html("Internal system error on parseLoginEmailCheck. Please contact Administrator with this message.");
                $("#login_error").show();
            }
        }
        else
        {
            $("#login_error").html("Internal system error on parseLoginEmailCheck. Please contact Administrator with this message.");
            $("#login_error").show();
        }
    }

    function parseLoginEmailCheckAndLogin(data)
    {
        var jsonObj = $.parseJSON(data);

        // No email found! STOP and show message!
        if(jsonObj.result == "unique")
        {
            $("#loginModal #noregister_username").show();
        }
        else if (jsonObj.result == "duplicate")
        {
            // Only One email found, then try LOGGING IN
            if (jsonObj.count == 1)
            {
                // Serialize values in the form (Encode a set of form elements as a string for submission)
                var values = $("#Login").serialize();

                // Send a request to login
                $.ajax({
                    url: '/index.php',
                    type: 'POST',
                    data: values,
                    success: function(data) {
                        var pos 		= data.indexOf("<title>Error");
                        var titlePos 	= data.indexOf("<title>");

                        // Logging in Error
                        if (pos == titlePos)
                        {
                            $("#incorrect_password").show();
                            return false;
                        }
                        else
                        {
                            {if screen_name=="Anonymous Member"}
                                UpdateStats(2, 0); // Updates and then reloads after
                            {if:else}
                                var form_loader = $('.login_form [name=RET]').val();
                                form_loader = form_loader.charAt(0);
                                if (form_loader=="!")
                                {
                                    window.location.href = location.href+$('.login_form [name=RET]').val();
                                }
                                else
                                {
                                    location.reload();
                                }
                            {/if}
                        }
                    }
                });
            }
            // Multiple email found, STOP and show message
            else if (jsonObj.count > 1)
            {
                $("#loginModal #multiple_username").show();
                console.warning(jsonObj.count + " email addresses exist.");
            }
            else
            {
                $("#login_error").html("Internal system error on parseLoginEmailCheckAndLogin. Please contact Administrator with this message.");
                $("#login_error").show();
            }
        }
        else 
        {
            $("#login_error").html("Internal system error on parseLoginEmailCheckAndLogin. Please contact Administrator with this message.");
            $("#login_error").show();
        }
    }

    function parseRegisterEmailCheck(data) 
    {
        var jsonObj = $.parseJSON(data);

        // No email found, GOOD TO GO!
        if(jsonObj.result == "unique") 
        {
        } 
        // Email already exists! STOP and Show message!
        else if (jsonObj.result == "duplicate") 
        {
            // One email found
            if (jsonObj.count == 1) 
            {
                $("#registerModal #registered_username").show();
            }
            // Multiple emails found
            else if (jsonObj.count > 1) 
            {
                $("#registerModal #multiple_username").show();
                console.warning(jsonObj.count + " email addresses exist.");
            } 
            else
            {
                $("#register_error").html("Internal system error on parseRegisterEmailCheck. Please contact Administrator with this message.");
                $("#register_error").show();
            }
        }
        else
        {
            $("#register_error").html("Internal system error on parseRegisterEmailCheck. Please contact Administrator with this message.");
            $("#register_error").show();
        }
    }

    function parseRegisterEmailCheckAndRegister(data)
    {
        var jsonObj = $.parseJSON(data);

        // No email found, GOOD TO GO!
        if(jsonObj.result == "unique") 
        {
            // Create an Account in EE
            createEEAccount();
        }
        // Email already exists! STOP and Show message!
        else if (jsonObj.result == "duplicate")
        {
            // One email found
            if (jsonObj.count == 1)
            {
                $("#registerModal #registered_username").show();
            }
            // Multiple emails found
            else if (jsonObj.count > 1)
            {
                $("#registerModal #multiple_username").show();
                console.warning(jsonObj.count + " email addresses exist.");
            }
            else
            {
                $("#register_error").html("Internal system error on parseRegisterEmailCheckAndRegister. Please contact Administrator with this message.");
                $("#register_error").show();
            }
        }
        else
        {
            $("#register_error").html("Internal system error on parseRegisterEmailCheckAndRegister. Please contact Administrator with this message.");
            $("#register_error").show();
        }
    }

    function createEEAccount()
    {
        // Retrieve values in the form at Register modal
        var email 		= $("#registerModal #regusername").val().trim();
        var	firstname 	= $("#registerModal #firstname").val().trim();
        var	lastname 	= $("#registerModal #lastname").val().trim();
        var	password 	= $("#registerModal #regpassword").val();
        var	accept 		= $("#registerModal #accept_terms").val();

        var username 	= email.replace("@", "_");

        // Create a new account in the DB directly
        $.ajax({
            url: '/scripts/password_init_set.php?email=' + email + '&password=' + password + '&username=' + username + '&firstname=' + firstname + '&lastname=' + lastname, 
            async: false,
            success: function(data) {
                var csrftoken	= $("input[name=csrf_token]").val();

                // EE auto-login
                $.ajax({
                    type: "POST",
                    url: '{site_url}/index.php',
                    data: "username="+email+"&password="+password+"&ACT=9"+"&RET='{site_url}/index.php/prelaunchmain/register_success"+"&site_id=1",
                    async: false,
                    success: function() {
                        location.reload();
                    },
                    error: function() {
                        $("#register_error").html("Internal system error on Auto-logging in. Please contact Administrator with this message.");
                        $("#register_error").show();
                    }
                });

            },
            error: function(data) {
                $("#register_error").html("Internal system error on createEEAccount. Please contact Administrator with this message.");
                $("#register_error").show();
            }
        });
    }

    function clearAllAlert()
    {
        $(".alert").hide();
        $(".alert-secondary").show();
        $(".alert-info").show();
    }

    /////////////////////////////////////////////////////////////////////
    // 		Check validation of Email 
    /////////////////////////////////////////////////////////////////////
    function validateEmail(email) {
        var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/;

        return re.test(email);
    }

    function isEmpty(val) {
        return val == "";
    }

    function logoutandreload()
    {
    //	$.post("/scripts/update_worship_heartbeat.php", { member_id: "<?php echo $member_id_reference; ?>", disconnect: "1" });

    //	$.cookies.del('ee_screenname');

        $.ajax({
            url: "/?ACT=10&csrf_token={csrf_token}",
            complete: function() {
                location.reload();
            }
        });
    }

    /////////////////////////////////////////////////////////////////////////////////////
    // 		End of Functions for Login/Register
    /////////////////////////////////////////////////////////////////////////////////////

    {if service_live != "true"}
        var service_live_prompted = 0; 	// Have we already asked the user if they want to join live service?

        function CheckServiceLive() {
            if (service_live_prompted == 0) {
                UpdateCheckServiceLive();
                setTimeout("CheckServiceLive()", 30000);
            }
        }

        function UpdateCheckServiceLive() {
            $.ajax({
                url: "/_component/isservicelive",
                success: function(data) {
                    if (data.indexOf("true") != -1) {
                        if (service_live_prompted == 0) {
                            var r = confirm("You are currently watching last week's service. This weeks' service is now live. Would you like to join live online worship?");
                            if (r == true) { location.reload(); }
                            service_live_prompted = 1;
                        }
                    }
                }
            });
        }
    {/if}


    function LoadSpanish()
    {
        $("#media_iframe").html("<iframe src='https://www.streammonkey.com/iframe/2678' width='100%' height='350px' frameborder='0' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>");

        generate_translation_message("Spanish");
    }

    function LoadDeaf()
    {
        $("#media_iframe").html("<iframe src='https://www.streammonkey.com/iframe/3377' width='100%' height='350px' frameborder='0' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>");

        generate_translation_message("Deaf");
    }

    function LoadEnglish()
    {
        $("#media_iframe").html("<iframe src='//player.streammonkey.com/iframe/REUQk4eV' width='100%' height='100%' frameborder='0' style='position: absolute;top: 0;left: 0;width: 100%;height: 100%;' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>");
    //		$("#media_iframe").html("<iframe src='//player.streammonkey.com/iframe/vlmouwbw' width='100%' height='100%' frameborder='0' style='position: absolute;top: 0;left: 0;width: 100%;height: 100%;' allowfullscreen webkitAllowFullScreen mozAllowFullscreen></iframe>");
        $("#backup-replace").html('<a href="#" onclick="LoadYoutube(); return false;" class="underline">Click here to use our backup stream.</a>')

        generate_translation_message("English");
    }

    function LoadYoutube()
    {
        $("#media_iframe").html("<iframe width='100%' height='350' src='https://www.youtube.com/embed/live_stream?channel=UCqV9iVqSzr5odrCDdkEmogw&autoplay=1' frameborder='0' allowfullscreen></iframe>");
        $("#backup-replace").html('<a href="#" onclick="LoadEnglish(); return false;" class="underline">Return to our primary stream.</a>')

        generate_translation_message("YouTube");
    }

    function setCookie(key, value, expiry) {
        var expires = new Date();
        expires.setTime(expires.getTime() + (expiry * 1000));
        document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
    }

    function getCookie(key) {
        var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
        return keyValue ? keyValue[2] : null;
    }

    function eraseCookie(key) {
        var keyValue = getCookie(key);
        setCookie(key, keyValue, '-1');
    }

    function generate_translation_message(source)
    {
        var cur_time = {current_time format="%G%i"};

        if ((cur_time > 430) && (cur_time < 1000))
        {
            switch (source) {
                case "English":
                    $("#translation_english").removeClass("btn-secondary").addClass("btn-primary");
                    $("#translation_spanish").removeClass("btn-primary").addClass("btn-secondary");
                    $("#translation_deaf").removeClass("btn-primary").addClass("btn-secondary");

                    $("#translation_english").prop("disabled", true);
                    $("#translation_spanish").prop("disabled", false);
                    $("#translation_deaf").prop("disabled", true);
                    break;
                case "Spanish":
                    $("#translation_spanish").removeClass("btn-secondary").addClass("btn-primary");
                    $("#translation_english").removeClass("btn-primary").addClass("btn-secondary");
                    $("#translation_deaf").removeClass("btn-primary").addClass("btn-secondary");

                    $("#translation_english").prop("disabled", false);
                    $("#translation_spanish").prop("disabled", true);
                    $("#translation_deaf").prop("disabled", true);
                    break;
                case "YouTube":
                    $("#translation_english").prop("disabled", false);
                    $("#translation_spanish").prop("disabled", false);
                    $("#translation_deaf").prop("disabled", true);
                    break;
                default:
            }
        }
        else if ((cur_time > 1020) && (cur_time < 1330))
        {
            switch (source) {
                case "English":
                    $("#translation_english").removeClass("btn-secondary").addClass("btn-primary");
                    $("#translation_spanish").removeClass("btn-primary").addClass("btn-secondary");
                    $("#translation_deaf").removeClass("btn-primary").addClass("btn-secondary");

                    $("#translation_english").prop("disabled", true);
                    $("#translation_spanish").prop("disabled", false);
                    $("#translation_deaf").prop("disabled", false);
                    break;
                case "Spanish":
                    $("#translation_spanish").removeClass("btn-secondary").addClass("btn-primary");
                    $("#translation_english").removeClass("btn-primary").addClass("btn-secondary");
                    $("#translation_deaf").removeClass("btn-primary").addClass("btn-secondary");

                    $("#translation_english").prop("disabled", false);
                    $("#translation_spanish").prop("disabled", true);
                    $("#translation_deaf").prop("disabled", false);
                    break;
                case "Deaf":
                    $("#translation_deaf").removeClass("btn-secondary").addClass("btn-primary");
                    $("#translation_english").removeClass("btn-primary").addClass("btn-secondary");
                    $("#translation_spanish").removeClass("btn-primary").addClass("btn-secondary");

                    $("#translation_english").prop("disabled", false);
                    $("#translation_spanish").prop("disabled", false);
                    $("#translation_deaf").prop("disabled", true);
                    break;
                case "YouTube":
                    $("#translation_english").prop("disabled", false);
                    $("#translation_spanish").prop("disabled", false);
                    $("#translation_deaf").prop("disabled", false);
                    break;
                default:
            }
        }
        else if ((cur_time > 1630) && (cur_time < 2100))
        {
            switch (source) {
                case "English":
                    $("#translation_english").removeClass("btn-secondary").addClass("btn-primary");
                    $("#translation_spanish").removeClass("btn-primary").addClass("btn-secondary");
                    $("#translation_deaf").removeClass("btn-primary").addClass("btn-secondary");

                    $("#translation_english").prop("disabled", true);
                    $("#translation_spanish").prop("disabled", true);
                    $("#translation_deaf").prop("disabled", true);
                    break;
                case "YouTube":
                    $("#translation_english").prop("disabled", false);
                    $("#translation_spanish").prop("disabled", true);
                    $("#translation_deaf").prop("disabled", true);
                    break;
                default:
            }
        }
        else
        {
            $("#translation_english").prop("disabled", true);
            $("#translation_spanish").prop("disabled", true);
            $("#translation_deaf").prop("disabled", true);
        }
    }
</script>
</body>
</html>
